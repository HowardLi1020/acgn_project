{% extends '[BASE]ALL.html' %}
{% load static %} 
{% block app_css %}
<style>
/* 隱藏頂端列 */
.app-header-inner {
    display: none;
}
/* 取消主板 .app 的 padding-top 設置 */
.app {
    padding-top: 0 !important;
}

.image-comparison {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin-bottom: 30px;
    justify-content: center;
}
.image-box {
    width: 300px;
    text-align: center;
    border: 1px solid #ddd;
    padding: 10px;
    border-radius: 5px;
    background-color: white;
}
.image-title {
    font-weight: bold;
    margin-bottom: 5px;
    color: #333;
}
.similarity-info {
    font-size: 1.2em;
    margin: 15px 0;
    color: #333;
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.similarity-high {
    background-color: #e7f5e7;
    border-left: 5px solid #28a745;
}
.similarity-medium {
    background-color: #fff3cd;
    border-left: 5px solid #ffc107;
}
.similarity-low {
    background-color: #f8f9fa;
    border-left: 5px solid #6c757d;
}
.similarity-description {
    margin-top: 10px;
    font-style: italic;
}
.similarity-score {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
}
.similarity-percent {
    font-size: 1.5em;
    font-weight: bold;
    color: #0066cc;
}
.similarity-bar {
    height: 8px;
    width: 100%;
    background-color: #e9ecef;
    border-radius: 4px;
    margin: 10px 0;
    overflow: hidden;
}
.similarity-bar-fill {
    height: 100%;
    background: linear-gradient(to right, #4da6ff, #0066cc);
    border-radius: 4px;
}
.error-message {
    padding: 15px;
    background-color: #fee;
    border-left: 5px solid #f55;
    margin-bottom: 20px;
    border-radius: 5px;
}
.result-card {
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    margin-bottom: 20px;
    padding: 15px;
}
.result-heading {
    color: #0066cc;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
}
.similar-images-section {
    margin-top: 30px;
    background-color: #f9f9f9;
    padding: 20px;
    border-radius: 8px;
}
.similar-image-card {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
    padding: 10px;
    background-color: white;
    border-radius: 5px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.similar-image-rank {
    font-size: 1.2em;
    font-weight: bold;
    margin-right: 15px;
    color: #666;
    width: 30px;
    text-align: center;
}
.similar-image-container {
    width: 100px;
    height: 100px;
    overflow: hidden;
    margin-right: 15px;
}
.similar-image-container img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}
.similar-image-info {
    flex-grow: 1;
}
.similar-image-similarity {
    font-weight: bold;
    color: #0066cc;
}
.attention-section {
    margin-top: 30px;
    background-color: #f0f8ff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}
.attention-title {
    color: #0066cc;
    margin-bottom: 15px;
    font-size: 1.4em;
    font-weight: bold;
}
.attention-description {
    margin-bottom: 20px;
    line-height: 1.6;
}
.attention-images {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    justify-content: center;
}
.attention-image-box {
    width: 300px;
    text-align: center;
    border: 1px solid #ddd;
    padding: 10px;
    border-radius: 5px;
    background-color: white;
}
.attention-image-title {
    font-weight: bold;
    margin-bottom: 10px;
    color: #333;
}
.attention-guide {
    background-color: #e9f7fe;
    padding: 10px;
    margin-top: 20px;
    border-radius: 5px;
    font-style: italic;
}
</style>
{% endblock %}

{% block app_title %}
<!-- 直接打文字即可替換各自應用程式的標題 -->
AI 圖片比對結果
{% endblock %} 

{% block app_content %}
<div class="container">
    {% if error_message %}
    <div class="error-message">
        <h3>處理過程中發生錯誤：</h3>
        <p>{{ error_message }}</p>
        <p>請嘗試上傳其他圖片或聯繫管理員。</p>
    </div>
    {% endif %}
    
    {% if best_match %}
    <div class="result-card">
        <h2 class="result-heading">比對結果</h2>
        
        {% if is_very_similar %}
        <div class="similarity-info similarity-high">
        {% elif similarity > 85 %}
        <div class="similarity-info similarity-high">
        {% elif similarity > 70 %}
        <div class="similarity-info similarity-medium">
        {% else %}
        <div class="similarity-info similarity-low">
        {% endif %}
            <div class="similarity-score">
                <div>
                    <strong>相似度評分</strong>
                </div>
                <div class="similarity-percent">{{ similarity }}%</div>
            </div>
            
            <div class="similarity-bar">
                <div class="similarity-bar-fill" style="width:{{ similarity }}%"></div>
            </div>
            
            {% if similarity_description %}
            <div class="similarity-description">{{ similarity_description }}</div>
            {% endif %}
        </div>
        
        <div class="image-comparison">
            <div class="image-box">
                <div class="image-title">上傳的圖片</div>
                <img src="{{ MEDIA_URL }}uploads/{{ uploaded_image }}" class="img-fluid" alt="上傳的圖片">
            </div>
            
            <div class="image-box">
                <div class="image-title">最相似的圖片</div>
                <img src="{{ best_match_image_url }}" class="img-fluid" alt="最相似的圖片">
            </div>
        </div>
        
        <div class="alert alert-info mt-3">
            <strong>CLIP 模型比對說明：</strong> CLIP 是一個由 OpenAI 開發的多模態模型，可以理解圖像和文本之間的關聯。
            在圖片比對時，CLIP 將圖片轉換為高維向量，並計算向量之間的相似度。相似度越高，表示圖片在語義層面上越相似。
            CLIP 能夠識別相同角色、相似場景或主題相關的圖片，而不僅僅是基於顏色或像素的相似性。
        </div>
    </div>

    {% if uploaded_attention_url or best_match_attention_url %}
    <div class="attention-section">
        <h3 class="attention-title">CLIP 模型注意力視覺化</h3>
        <div class="attention-description">
            下方顯示了 CLIP 模型在處理圖片時的注意力分佈，使用基於 Transformer 的視覺化技術生成。
            <strong>紅色/黃色區域</strong>表示模型關注度較高的區域，這些區域在圖片特徵提取過程中被認為具有更強的識別性；
            <strong>藍色區域</strong>表示模型標準注意的一般區域。此視覺化幫助理解模型如何區分不同圖像中的特徵。
        </div>
        
        <div class="attention-images">
            {% if uploaded_attention_url %}
            <div class="attention-image-box">
                <div class="attention-image-title">上傳圖片的注意力分佈</div>
                <img src="{{ uploaded_attention_url }}" class="img-fluid" alt="上傳圖片的注意力分佈">
            </div>
            {% endif %}
            
            {% if best_match_attention_url %}
            <div class="attention-image-box">
                <div class="attention-image-title">匹配圖片的注意力分佈</div>
                <img src="{{ best_match_attention_url }}" class="img-fluid" alt="匹配圖片的注意力分佈">
            </div>
            {% endif %}
        </div>
        
        <div class="attention-guide">
            <p><strong>如何解讀：</strong> 觀察視覺化結果可幫助您了解 CLIP 模型如何分析圖片。紅色/黃色區域表示在圖片比對過程中更具識別性的部分，模型認為這些特徵對於區分圖片特別有幫助。注意這種識別與人類直覺可能不同 - 有時模型會關注服裝、背景或姿勢等元素，而非僅關注面部特徵。</p>
        </div>
    </div>
    {% endif %}

    {% if similar_images %}
    <div class="similar-images-section">
        <h3 class="mb-4">其他相似圖片</h3>
        
        {% for image in similar_images %}
        <div class="similar-image-card">
            <div class="similar-image-rank">#{{ image.rank }}</div>
            <div class="similar-image-container">
                <img src="{{ image.image_url }}" alt="相似圖片 #{{ image.rank }}">
            </div>
            <div class="similar-image-info">
                <div class="similar-image-similarity">相似度: {{ image.similarity }}%</div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    {% if work_info %}
    <div class="card mt-4">
        <div class="card-header">作品資訊</div>
        <div class="card-body">
            <h5 class="card-title">{{ work_info.work_title }}</h5>
            <p class="card-text">{{ work_info.work_description }}</p>
            {% if work_info.worker_id %}
            <p><strong>作者ID:</strong> {{ work_info.worker_id }}</p>
            {% endif %}
        </div>
    </div>
    {% endif %}
    
    {% else %}
    <div class="alert alert-warning">
        沒有找到相似圖片。
    </div>
    {% endif %}
    
    <a href="{% url 'commission:Urls_upload_compare' %}" class="btn btn-primary mt-3">重新上傳比對</a>
</div>
{% endblock %}

{% block app_script %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('相似圖片結果頁面已加載');
    // 檢查是否有相似圖片
    var similarImagesSection = document.querySelector('.similar-images-section');
    if (similarImagesSection) {
        console.log('找到相似圖片區塊');
    }
    
    // 檢查是否有注意力視覺化圖片
    var attentionSection = document.querySelector('.attention-section');
    if (attentionSection) {
        console.log('找到注意力視覺化區塊');
    }
});
</script>
{% endblock %}
