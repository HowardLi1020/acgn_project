{% extends '[BASE]ALL.html' %}
{% load static %} 
{% block app_css %}
<!-- 如果應用程式有自己的css放這邊 -->
<style>
  /* 隱藏頂端列 */
  .app-header-inner {
    display: none;
  }
  /* 取消主板 .app 的 padding-top 設置 */
  .app {
    padding-top: 0 !important;
  }

  /* 頭像和個人資訊容器 */
  .profile-info-container {
    position: absolute;
    top: -120px; /* 頭像與 banner 的高度距離，數字越小越上方 */
    left: 50px; /* 頭像與左邊界的距離 */
    right: 20px;
    z-index: 1;
    overflow: visible; /* 允許內容超出容器 */
  }

  /* 右側區域容器樣式 */
  .right-section {
    position: static; /* 移除相對定位 */
    flex: 1; /* 讓右側區域佔據剩餘空間 */
    padding-left: 40px; /* 與左側區域保持間距 */
  }

  /* 頭像與橫幅-自訂圖開關的字體大小 */
  .form-check-label {
    font-size: 0.85rem; /*  調整字體大小 */
  }

  /* 右側開關區域的獨立樣式 */
  .right-section .form-check {
    position: relative; /* 設置相對定位作為參考點 */
    padding-right: 60px; /* 為開關預留空間 */
    margin-bottom: 1rem;
  }

  /* 右側區域表單標籤樣式 */
  .right-section .form-check-label {
    font-size: 1rem;
  }

  /* 右側區域表單輸入樣式 */
  .right-section .form-check-input {
    position: absolute; /* 絕對定位 */
    right: 40rem; /* 文字與開關的距離，越大越近 */
    top: 40%; /* 垂直置中 */
    transform: translateY(-50%); /* 精確垂直置中 */
    margin: 0; /* 清除預設邊距 */
  }

  /* 列表樣式 */
  .content-list {
    /*list-style: none;  移除預設的列表符號 */
    padding: 0;
    margin: 0;
  }

  /* 內容列表項目樣式 */
  .content-list li {
    position: relative;
    padding-left: 1.5em; /* 為自訂符號留空間 */
    margin-bottom: 1rem;
  }

  /* 內容列表項目前景樣式 */
  .content-list li::before {
    /* content: "●"; */
    position: absolute;
    left: 0;
    color: #333;
  }

  /* 開關容器樣式 */
  .content-list .form-check {
    display: flex;
    flex-direction: row-reverse;
    justify-content: space-between;
    align-items: center;
    margin: 0;
    padding: 0;
  }

  /* 內容列表表單標籤樣式 */
  .content-list .form-check-label {
    font-size: 1rem;
    margin-right: 10px;
  }

  /* 開關展開內容區域 */
  .expandable-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out;
    padding-left: 1.5em;
  }

  /* 開關展開時的狀態 */
  .expandable-content.show {
    max-height: 5000px; /* 設置一個足夠大的高度，但不要太大以免影響動畫效果 */
    transition: max-height 0.5s ease-in;
  }

  /* 調整按鈕樣式以匹配輸入框高度 */
  .input-group .btn {
    height: 40px; /* 使按鈕高度與輸入框相同 */
    padding: 0.375rem 0.75rem; /* 調整內邊距 */
    display: flex; /* 確保按鈕內部元素垂直居中 */
    align-items: center; /* 垂直居中 */
  }

  /* 修正 form-check 的樣式 */
  .content-list .form-check.me-3 {
    flex-direction: row; /* 覆蓋 row-reverse */
    justify-content: flex-start; /* 覆蓋 space-between */
  }

  /* 輸入框(含喜好作品、屬性Tag、價目表區)-提示字 placeholder 樣式 */
  .form-control::placeholder {
    font-size: 0.875rem;  /* 14px，比預設的 16px 小一點 */
    color: #7b838d;          /* 淺灰色 */
    opacity: 0.8;         /* 稍微調整透明度 */
  }

  /* 提交表單按鈕組(返回上層、保存非公開、保存並公開)-黏性浮動按鈕 */
  .sticky-buttons {
    position: sticky; /* 實現黏性定位效果 */
    bottom: 20px; /* 始終距離視窗底部20px */
    z-index: 1000; /* 確保按鈕在最上層 */
    /* background: rgba(255, 255, 255, 0.233); */
    /* box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); */
    padding: 10px;
    /* backdrop-filter: blur(3px); 毛玻璃效果 */
    border-radius: 8px;
  }

  /* 提交表單按鈕組-按鈕包裝容器 */
  .button-wrapper {
    position: relative;
    display: inline-block;
  }

  /* 提交表單按鈕組-按鈕遮罩層 */
  .button-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 8px; /* 同按鈕設定之margin-right */
    bottom: 0;
    background: rgba(128, 128, 128, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: white;
    font-size: 0.9rem;
    border-radius: 0.4rem; /* 同按鈕圓角 */
    z-index: 1001;
    backdrop-filter: blur(1px);
    transition: all 0.3s ease;
  }

  /* 提交表單按鈕組-按鈕遮罩層-hover效果 */
  .button-overlay:hover {
    background: rgba(128, 128, 128, 0.7);
  }

  /* 提交表單按鈕組-按鈕遮罩層-移除遮罩層的樣式 */
  .button-overlay.removed {
    opacity: 0;
    pointer-events: none;
  }

  

</style>
{% endblock %}
{% block app_title %}
<!-- 直接打文字即可替換各自應用程式的標題 -->
名片資訊編輯 (使用者ID：{{ ViewKey_DbPublicCardInfo.pk }}) 

{% endblock %} 
{% block app_content %}
<!-- 白底編輯區 -->
<div
  class="app-card app-card-settings shadow-sm p-4 mb-4 d-flex flex-column"
  style="flex-grow: 1"
>
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {% include 'commission/publiccard_edit_test/banner.html' %}
    

    <!-- 頭像和個人資訊區域 -->
    <div class="profile-info-container d-flex position-relative">
      {% include 'commission/publiccard_edit_test/avatar.html' %}
      {% include 'commission/publiccard_edit_test/user_info.html' %}      
    </div>

    <!-- 新增一個容器來包住兩個區塊 -->
    <div class="sections-container" style="display: flex; margin-top: -90px">
      <!-- 左側區域 -->
      {% include 'commission/publiccard_edit_test/favorite_and_tag.html' %}


      <!-- 右側區域(分隔線區分兩側) -->
      <div class="right-section" style="border-left: 1px solid #dee2e6;">
        <ul class="content-list">
          {% include 'commission/publiccard_edit_test/sell_list.html' %}
          {% include 'commission/publiccard_edit_test/work_sellnow.html' %}
          {% include 'commission/publiccard_edit_test/work_done.html' %}
          {% include 'commission/publiccard_edit_test/need.html' %}
        </ul>
      </div>
    </div>
    <div class="d-flex justify-content-end mt-3 sticky-buttons">
      <div class="button-wrapper">
        <div class="button-overlay" data-target="cancelButton">點擊解除保護</div>
        <a href="#" id="cancelButton" class="btn app-btn-secondary me-2" disabled>返回上層</a>
      </div>
      <div class="button-wrapper">
        <div class="button-overlay" data-target="savePrivateButton">點擊解除保護</div>
        <button type="submit" id="savePrivateButton" 
                class="btn app-btn-warning me-2" 
                style="background-color: #facf4d; border-color: #facf4d" 
                disabled
                data-status="非公開">保存非公開</button>
      </div>
      <div class="button-wrapper">
        <div class="button-overlay" style="right: 0;" data-target="savePublicButton">點擊解除保護</div>
        <button type="submit" id="savePublicButton" 
                class="btn app-btn-primary" 
                disabled
                data-status="公開">保存並公開</button>
      </div>
    </div>
  </form>
</div>

{% endblock %} 
{% block app_script %}
<!-- 新增 Sortable.js 拖曳排序功能 -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
// === 全域表單變化監聽 ===
document.querySelector('form').addEventListener('input', function(e) {
  const changedField = e.target;
  // 自動收集所有表單資料
  const formData = new FormData(this);
  
  // 添加自定義識別屬性 (可選)
  if (changedField.hasAttribute('data-subtemplate')) {
    formData.append('subtemplate', changedField.getAttribute('data-subtemplate'));
  }
});

// === 表單提交處理 ===
$(document).ready(function() {
    // 初始化圖片拖曳排序功能
    function initializeImageSortable(container) {
        new Sortable(container, {
            animation: 150,  // 恢復原始動畫時間
            handle: '.image-preview-wrapper', // 只能拖曳圖片預覽區
            ghostClass: 'sell-item-ghost',    // 使用與價目表相同的樣式
            chosenClass: 'sell-item-chosen',
            dragClass: 'sell-item-drag',
            forceFallback: false,  // 關閉強制回退模式
            fallbackTolerance: 3, 
            swapThreshold: 0.5,   
            direction: 'horizontal', // 限制為水平方向拖動
            scroll: true,  // 啟用滾動
            bubbleScroll: true, // 允許冒泡滾動
            scrollSensitivity: 30, // 觸發滾動的敏感度
            scrollSpeed: 10, // 滾動速度
            onStart: function(evt) {
                // 添加拖動開始時的樣式
                evt.item.classList.add('sortable-dragging');
            },
            onEnd: function(evt) {
                // 移除拖動結束時的樣式
                evt.item.classList.remove('sortable-dragging');
                
                // 更新圖片順序標記
                const images = container.querySelectorAll('.image-preview-wrapper');
                images.forEach((img, index) => {
                    // 使用 index + 1 作為 sort_order，確保從 1 開始
                    img.setAttribute('data-sort-order', index + 1);
                    console.log(`更新圖片排序: ID=${img.getAttribute('data-image-id')}, 順序=${index + 1}`);
                });
            }
        });
    }

    // 為所有現有圖片容器初始化
    $('.sell-content-wrapper').each(function() {
        const imageContainer = $(this).find('.d-flex[style*="gap: 10px"]')[0];
        if (imageContainer) {
            initializeImageSortable(imageContainer);
        }
    });
    
    $('form').submit(function(event) {
        event.preventDefault(); // 阻止表單的默認提交行為
        
        // 喜好作品-收集並存儲喜好作品數據
        var acgnItems = [];
        $('#favoriteAcgnList li .acgn-text').each(function() {
            acgnItems.push($(this).text().trim());
        });
        $('#involved_acgn_hidden').val(acgnItems.join(','));
        
        // 屬性Tag-收集並存儲屬性標籤數據
        var tagItems = [];
        $('#tagsContainer .tag').each(function() {
            // 取得標籤文本，去除刪除按鈕的 '×' 字符
            var tagText = $(this).clone().children().remove().end().text().trim();
            tagItems.push(tagText);
        });
        $('#key_tags_hidden').val(tagItems.join(','));
        
        var formData = new FormData(this);
        
        // 小卡相關-寫入公開/非公開狀態
        var clickedButton = $(document.activeElement);
        if(clickedButton.is('button[type="submit"]')) {
            formData.append('ViewKey_bd_public_card_info_card_status', clickedButton.data('status'));
        }

        $.ajax({
            url: $(this).attr('action'),
            type: $(this).attr('method'),
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                alert('儲存成功: ' + response.message); // 彈出成功訊息
                window.location.reload(); // 重新加載頁面
            },
            error: function(response) {
                alert('儲存失敗: ' + response.responseText); // 彈出失敗訊息
            }
        });
    });
});

// === 右側內容區域開關初始化開關狀態並添加事件監聽器 ===
const switchStates = {
    // '開關控制ID': 從views.py連動的資料表.資料表欄位
    'switch-sell': JSON.parse('{{ ViewKey_DbPublicCardInfo.sell_public_status|lower|default:"false"|escapejs }}'.toLowerCase()),
    'switch-work-sellnow': JSON.parse('{{ ViewKey_DbPublicCardInfo.work_sellnow_list_public_status|lower|default:"false"|escapejs }}'.toLowerCase()),
    'switch-work-done': JSON.parse('{{ ViewKey_DbPublicCardInfo.work_done_list_public_status|lower|default:"false"|escapejs }}'.toLowerCase()),
    'switch-need-list': JSON.parse('{{ ViewKey_DbPublicCardInfo.need_list_public_status|lower|default:"false"|escapejs }}'.toLowerCase())
};

// 右側內容區域開關-初始化每個開關的狀態
Object.entries(switchStates).forEach(([switchId, initialState]) => {
  const switchElement = document.getElementById(switchId);
  if (switchElement) {
    // 設置初始狀態
    switchElement.checked = initialState;
    // 初始化內容區域的顯示狀態
    const contentId = `content-${switchId.replace('switch-', '')}`;
    const contentEl = document.getElementById(contentId);
    const privateMessage = contentEl.previousElementSibling;
    
    if (contentEl) {
      // 控制初始化時的顯示內容
      if (initialState) { 
        // 如果開關狀態(取自資料表欄位資料)為 true，顯示原定內容，隱藏「使用者未開放資訊」字樣
        privateMessage.style.display = 'none';
        contentEl.classList.add("show");
      } else {
        privateMessage.style.display = 'block';
        contentEl.classList.remove("show");
      }
    }
    // 開關事件監聽器
    switchElement.addEventListener('change', function(e) {
      // const contentId = `content-${switchId.replace('switch-', '')}`;
      // const contentEl = document.getElementById(contentId);
      // const privateMessage = contentEl.previousElementSibling;
      
      if (contentEl) {
        // 控制模板開關改變時的顯示內容
        if (this.checked) {
          // 開關開啟：顯示公開內容，隱藏「使用者未開放資訊」字樣
          privateMessage.style.display = 'none';
          contentEl.classList.add("show");
        } else {
          // 開關關閉：顯示「使用者未開放資訊」字樣，隱藏公開內容
          privateMessage.style.display = 'block';
          contentEl.classList.remove("show");
        }
      }
    });
  }
});

// === 提交表單按鈕組-按鈕遮罩層-點擊事件 ===
document.addEventListener('DOMContentLoaded', function() {
    const buttonOverlays = document.querySelectorAll('.button-overlay');
    const stickyButtons = document.querySelector('.sticky-buttons');
    const originalButtonsPosition = stickyButtons.offsetTop;
    let isInOriginalPosition = true; // 追蹤按鈕組是否在原始位置

    // 提交表單按鈕組-處理遮罩層點擊
    buttonOverlays.forEach(overlay => {
        overlay.addEventListener('click', function() {
            toggleOverlay(this, false); // 手動點擊時永久移除
        });
    });

    // 提交表單按鈕組-監聽頁面滾動
    window.addEventListener('scroll', function() {
        const currentScroll = window.pageYOffset;
        const isAtOriginalPos = currentScroll <= originalButtonsPosition;

        // 提交表單按鈕組-當滾動狀態改變時才執行
        if (isAtOriginalPos !== isInOriginalPosition) {
            isInOriginalPosition = isAtOriginalPos;
            
            buttonOverlays.forEach(overlay => {
                const targetButton = document.getElementById(overlay.dataset.target);
                if (isAtOriginalPos) {
                    // 回到原始位置時恢復遮罩
                    toggleOverlay(overlay, true);
                } else {
                    // 離開原始位置時移除遮罩
                    toggleOverlay(overlay, false);
                }
            });
        }
    });

    // 提交表單按鈕組-統一處理遮罩狀態的函數
    function toggleOverlay(overlay, show) {
        const targetButton = document.getElementById(overlay.dataset.target);
        if (show) {
            overlay.classList.remove('removed');
            targetButton.disabled = true;
        } else {
            overlay.classList.add('removed');
            targetButton.disabled = false;
        }
    }
});

// 價目表圖片 - 處理文件選擇變更
$(document).on('change', 'input[type="file"][name^="sell_image_"]', function() {
    const $fileInput = $(this);
    const file = this.files[0];
    
    // 移除前導零
    const normalizedName = $fileInput.attr('name').replace(/^sell_image_0*(\d+)/, 'sell_image_$1');
    $fileInput.attr('name', normalizedName);
    
    if (file) {
        // 獲取圖片預覽容器
        const $previewContainer = $fileInput.closest('.image-preview-wrapper');
        
        // 創建 FileReader 讀取文件
        const reader = new FileReader();
        reader.onload = function(e) {
            // 移除舊的圖片預覽或預設圖標
            $previewContainer.empty();
            
            // 添加新的圖片預覽
            const $img = $('<img>').attr({
                'src': e.target.result,
                'alt': '示意圖',
                'style': 'width: 100%; height: 100%; object-fit: cover;'
            });
            $previewContainer.append($img);
            
            // 重新添加控制按鈕容器
            const imageId = parseInt($previewContainer.data('image-id')); // 確保 imageId 是整數 1 或 2
            const sellItemId = $previewContainer.data('sell-item-id');
            
            const $iconContainer = $('<div>').addClass('icon-container');
            
            // 檢視按鈕
            const $viewButton = $('<button>').attr({
                'type': 'button',
                'class': 'icon-button view-image',
                'title': '檢視原圖',
                'data-image-url': e.target.result
            }).html('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0z"/><path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8zm8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/></svg>');
            
            // 更換按鈕
            const $replaceButton = $('<button>').attr({
                'type': 'button',
                'class': 'icon-button replace-image',
                'title': '更換圖片',
                'data-image-id': imageId,
                'data-sell-item-id': sellItemId
            }).html('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M4.502 9a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3"/><path d="M14.002 13a2 2 0 0 1-2 2h-10a2 2 0 0 1-2-2V5A2 2 0 0 1 2 3a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v8a2 2 0 0 1-1.998 2M14 2H4a1 1 0 0 0-1 1h9.002a2 2 0 0 1 2 2v7A1 1 0 0 0 15 11V3a1 1 0 0 0-1-1M2.002 4a1 1 0 0 0-1 1v8l2.646-2.354a.5.5 0 0 1 .63-.062l2.66 1.773 3.71-3.71a.5.5 0 0 1 .577-.094l1.777 1.947V5a1 1 0 0 0-1-1z"/></svg>');
            
            // 刪除按鈕
            const $deleteButton = $('<button>').attr({
                'type': 'button',
                'class': 'icon-button delete-image',
                'title': '刪除',
                'data-image-id': imageId,
                'data-sell-item-id': sellItemId
            }).html('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5M11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66h.538a.5.5 0 0 0 0-1zm1.958 1-.846 10.58a1 1 0 0 1-.997.92h-6.23a1 1 0 0 1-.997-.92L3.042 3.5zm-7.487 1a.5.5 0 0 1 .528.47l.5 8.5a.5.5 0 0 1-.998.06L5 5.03a.5.5 0 0 1 .47-.53Zm5.058 0a.5.5 0 0 1 .47.53l-.5 8.5a.5.5 0 1 1-.998-.06l.5-8.5a.5.5 0 0 1 .528-.47M8 4.5a.5.5 0 0 1 .5.5v8.5a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5"/></svg>');
            
            // 添加按鈕到容器
            $iconContainer.append($viewButton, $replaceButton, $deleteButton);
            $previewContainer.append($iconContainer);
            
            // 重新添加文件輸入元素，確保 name 屬性格式正確
            $fileInput.attr('name', `sell_image_${imageId}_item_${sellItemId}`);
            $fileInput.attr('id', `sell_image_${imageId}_item_${sellItemId}`);
            $previewContainer.append($fileInput);
            
            // 修改：移除點擊事件但保持按鈕功能
            // 只移除 onclick 屬性，而不是將 onclick 設為 null
            $previewContainer.css('cursor', 'default').removeAttr('onclick');
            
            // 確保更換圖片按鈕的事件能被正確觸發
            $replaceButton.on('click', function(e) {
                e.stopPropagation(); // 阻止事件冒泡
                const imageId = $(this).data('image-id');
                const sellItemId = $(this).data('sell-item-id');
                const inputId = `sell_image_${imageId}_item_${sellItemId}`;
                $(`#${inputId}`).click();
            });
        };
        
        // 讀取文件
        reader.readAsDataURL(file);
    }
});

// 價目表圖片 - 刪除圖片
$(document).on('click', '.delete-image', function() {
    const imageId = parseInt($(this).data('image-id'), 10); // 確保是數字
    // 確保只能是 1 或 2
    const finalImageId = (imageId === 1 || imageId === 2) ? imageId : 1;
    
    const sellItemId = $(this).data('sell-item-id');
    const $previewContainer = $(this).closest('.image-preview-wrapper');
    const $fileInput = $(`#sell_image_${finalImageId}_item_${sellItemId}`);
    const $parentContainer = $previewContainer.parent();
    
    // 清空文件輸入
    $fileInput.val('');
    
    // 重置預覽區域
    $previewContainer.empty();
    
    // 添加預設圖標
    const $defaultContent = $('<div>').addClass('text-center text-muted').html(`
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" viewBox="0 0 16 16">
            <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
            <path d="M1.5 2A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h13a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2h-13zm13 1a.5.5 0 0 1 .5.5v6l-3.775-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12v.54A.5.5 0 0 1 1 12.5v-9a.5.5 0 0 1 .5-.5h13z"/>
        </svg>
        <p>上傳示意圖${finalImageId}</p>
    `);
    
    // 創建新的佔位符容器
    const $placeholderWrapper = $('<div>')
        .addClass('d-flex align-items-center justify-content-center image-preview-wrapper')
        .attr({
            'data-image-id': finalImageId,
            'data-sell-item-id': sellItemId,
            'data-is-placeholder': 'true'
        })
        .css({
            'flex': '1', 
            'border-radius': '5px', 
            'overflow': 'hidden', 
            'background-color': '#f8f9fa', 
            'min-height': '150px', 
            'cursor': 'pointer'
        });
    
    // 直接添加點擊處理函數（不使用.on方法），但只為佔位符添加
    $placeholderWrapper[0].onclick = function(e) {
        // 阻止事件冒泡以避免遞迴
        e.stopPropagation();
        
        // 檢查是否含有圖片，如果有則不觸發檔案選擇
        if (this.querySelector('img')) {
            return;
        }
        
        const sellItemId = this.getAttribute('data-sell-item-id');
        const imageId = parseInt(this.getAttribute('data-image-id')); // 確保 imageId 是整數 1 或 2
        const inputId = `sell_image_${imageId}_item_${sellItemId}`;
        
        // 使用原生方法觸發點擊
        const fileInput = document.getElementById(inputId);
        if (fileInput) {
            fileInput.click();
        }
    };
    
    $placeholderWrapper.append($defaultContent);
    
    // 重新添加文件輸入元素（清空後的），確保 name 屬性格式正確
    $fileInput.attr('name', `sell_image_${finalImageId}_item_${sellItemId}`);
    $fileInput.attr('id', `sell_image_${finalImageId}_item_${sellItemId}`);
    $placeholderWrapper.append($fileInput);
    
    // 添加隱藏輸入元素，標記此圖片需要刪除
    const $deleteMarker = $('<input>').attr({
        'type': 'hidden',
        'name': `sell_delete_image_${finalImageId}_item_${sellItemId}`,
        'value': 'true'
    });
    $placeholderWrapper.append($deleteMarker);
    
    // 替換原有的預覽容器
    $previewContainer.replaceWith($placeholderWrapper);
    
    // 重新計算佔位符序號
    updatePlaceholderNumbers($parentContainer);
});

// 新增函數：更新佔位符序號
function updatePlaceholderNumbers($container) {
    // 找出所有佔位符
    const $placeholders = $container.find('.image-preview-wrapper[data-is-placeholder="true"]');
    
    // 找出已存在的圖片預覽
    const $existingPreviews = $container.find('.image-preview-wrapper:not([data-is-placeholder="true"])');
    
    // 已存在圖片的 imageId 集合
    const existingImageIds = new Set(
        $existingPreviews.map(function() { 
            return parseInt($(this).data('image-id')); // 確保轉換為整數
        }).get()
    );
    
    // 可用的 imageId (1 或 2)
    const availableImageIds = [1, 2].filter(id => !existingImageIds.has(id));
    
    // 更新佔位符
    $placeholders.each(function(index) {
        if (index < availableImageIds.length) {
            const newImageId = availableImageIds[index];
            
            // 更新 data-image-id
            $(this).attr('data-image-id', newImageId);
            
            // 更新文字
            $(this).find('p').text(`上傳示意圖${newImageId}`);
            
            // 更新隱藏輸入元素的 name
            const sellItemId = $(this).data('sell-item-id');
            const $fileInput = $(this).find('input[type="file"]');
            $fileInput.attr('name', `sell_image_${newImageId}_item_${sellItemId}`);
            $fileInput.attr('id', `sell_image_${newImageId}_item_${sellItemId}`);
            
            // 更新onclick函數的imageId，但只為佔位符添加
            this.onclick = function(e) {
                e.stopPropagation();
                
                // 檢查是否含有圖片，如果有則不觸發檔案選擇
                if (this.querySelector('img')) {
                    return;
                }
                
                const sellItemId = this.getAttribute('data-sell-item-id');
                const imageId = newImageId; // 使用新分配的ID
                const inputId = `sell_image_${imageId}_item_${sellItemId}`;
                
                const fileInput = document.getElementById(inputId);
                if (fileInput) {
                    fileInput.click();
                }
            };
        }
    });
}

// 價目表圖片 - 檢視原圖功能
$(document).on('click', '.view-image', function() {
    const imageUrl = $(this).data('image-url');
    
    // 創建模態框
    const $modalOverlay = $('<div>').addClass('modal-overlay').click(function() {
        $(this).remove();
    });
    
    const $modalImage = $('<img>').addClass('modal-image').attr('src', imageUrl);
    
    $modalOverlay.append($modalImage);
    $('body').append($modalOverlay);
});

// 在表單提交前修正所有與圖片相關的輸入欄位名稱
$('form').on('submit', function(event) {
    // 建立一個映射來跟踪已使用的索引
    const usedIndices = {};
    
    // 收集圖片排序數據
    const imageOrderData = {};
    
    // 遍歷所有價目表項目的圖片容器
    $('.sell-content-wrapper').each(function() {
        const sellItemId = $(this).data('sell-id');
        const imageContainer = $(this).find('.d-flex[style*="gap: 10px"]');
        
        if (imageContainer.length > 0) {
            // 獲取該項目下所有圖片元素
            const images = imageContainer.find('.image-preview-wrapper');
            
            // 如果有多張圖片，記錄它們的順序
            if (images.length > 1) {
                const orderInfo = [];
                images.each(function(index) {
                    const imageId = parseInt($(this).data('image-id'), 10);
                    // 使用 data-sort-order 屬性，如果不存在則使用當前索引 + 1
                    const sortOrder = parseInt($(this).data('sort-order') || (index + 1), 10);
                    console.log(`收集圖片順序: ID=${imageId}, 順序=${sortOrder}`);
                    orderInfo.push({
                        image_id: imageId,
                        sort_order: sortOrder
                    });
                });
                
                // 確保按照 sort_order 排序
                orderInfo.sort((a, b) => a.sort_order - b.sort_order);
                
                // 將排序信息添加到數據對象中
                if (orderInfo.length > 0) {
                    imageOrderData[sellItemId] = orderInfo;
                }
            }
        }
    });
    
    // 如果有排序信息，創建一個隱藏輸入欄位將其添加到表單中
    if (Object.keys(imageOrderData).length > 0) {
        // 將排序數據轉換為 JSON 字符串
        const imageOrderJson = JSON.stringify(imageOrderData);
        console.log('圖片排序數據:', imageOrderJson);
        
        // 檢查是否已存在此隱藏欄位，如果存在則更新值
        let orderInput = $('input[name="sell_image_order_data"]');
        if (orderInput.length === 0) {
            // 不存在則創建新欄位
            orderInput = $('<input>').attr({
                'type': 'hidden',
                'name': 'sell_image_order_data'
            });
            $(this).append(orderInput);
        }
        
        // 設置欄位值
        orderInput.val(imageOrderJson);
    }
    
    // 原有的欄位名稱修正邏輯，但不要改變圖片索引的順序，以免影響排序
    $('input[type="file"][name^="sell_image_"]').each(function() {
        const originalName = $(this).attr('name');
        // 僅標準化名稱格式，不重新分配索引
        const correctedName = originalName.replace(/sell_image_(\d+)_item_(\d+)/, function(match, p1, p2) {
            // 保持原始的圖片索引
            let imageId = parseInt(p1, 10);
            
            // 確保索引值為1或2
            imageId = (imageId === 1 || imageId === 2) ? imageId : (imageId > 1 ? 2 : 1);
            
            return `sell_image_${imageId}_item_${p2}`;
        });
        
        if (originalName !== correctedName) {
            console.log(`標準化輸入欄位名稱：${originalName} -> ${correctedName}`);
            $(this).attr('name', correctedName);
            $(this).attr('id', correctedName);
        }
    });
    
    // 同樣處理刪除標記的欄位名稱
    $('input[type="hidden"][name^="sell_delete_image_"]').each(function() {
        const originalName = $(this).attr('name');
        const correctedName = originalName.replace(/sell_delete_image_(\d+)_item_(\d+)/, function(match, p1, p2) {
            // 保持原始的圖片索引
            let imageId = parseInt(p1, 10);
            
            // 確保索引值為1或2
            imageId = (imageId === 1 || imageId === 2) ? imageId : (imageId > 1 ? 2 : 1);
            
            return `sell_delete_image_${imageId}_item_${p2}`;
        });
        
        if (originalName !== correctedName) {
            console.log(`標準化刪除標記欄位名稱：${originalName} -> ${correctedName}`);
            $(this).attr('name', correctedName);
        }
    });
    
    // 提交前記錄所有圖片輸入欄位的最終狀態
    console.log('===== 提交前的最終欄位狀態 =====');
    $('input[type="file"][name^="sell_image_"]').each(function() {
        console.log(`最終欄位名稱：${$(this).attr('name')}`);
    });
});

// 增加全局更換圖片按鈕事件處理程序，確保按鈕功能永遠有效
// $(document).on('click', '.replace-image', function(e) {
//     e.stopPropagation(); // 阻止事件冒泡
//     const imageId = $(this).data('image-id');
//     const sellItemId = $(this).data('sell-item-id');
//     const inputId = `sell_image_${imageId}_item_${sellItemId}`;
    
//     // 使用尋找元素而不是直接透過 ID 獲取，以增加穩定性
//     const fileInput = document.getElementById(inputId) || $(`input[name="${inputId}"]`)[0];
//     if (fileInput) {
//         fileInput.click();
//     } else {
//         console.error(`找不到文件輸入元素: ${inputId}`);
//     }
// });

// === 返回上層按鈕 ===
$(document).ready(function() {
    // 當無上一頁可返回時，返回publiccard_list
    const cancelButton = document.getElementById('cancelButton');
    cancelButton.addEventListener('click', function(e) {
        e.preventDefault();
        if (window.history.length > 1) {
            window.history.back();
        } else {
            window.location.href = "{% url 'commission:Urls_publiccard_list' %}";
        }
    });
});
</script>

{% endblock %}
