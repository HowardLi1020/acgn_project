{% extends '[BASE]ALL.html' %} 
{% load static %} 
{% block app_css %}
<!-- 如果應用程式有自己的css放這邊 -->
<style>
  .btn-reset {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    line-height: 1.5;
    border-radius: 0.2rem;
  }

  .btn-reset svg {
    vertical-align: middle;
  }

  th[draggable="true"] {
    cursor: move;
    transition: background-color 0.3s ease;
  }

  th[draggable="true"].over {
    border: 2px dashed #000;
  }

  .drop-indicator {
    position: fixed;
    width: 4px;
    background-color: #666;
    pointer-events: none;
    z-index: 1000;
    transition: transform 0.1s ease, opacity 0.1s ease;
    box-shadow: 0 0 6px rgba(102, 102, 102, 0.6);
    opacity: 1;
  }

  .indicator {
    margin-left: 5px;
  }

  .dragging-column {
    opacity: 0.5;
    background-color: #f8f9fa;
  }

  .dragging-column th,
  .dragging-column td {
    background-color: #f8f9fa;
  }

  .column-hover {
    position: relative;
    transition: transform 0.3s ease;
  }

  .column-hover.shift-left {
    transform: translateX(-100%);
  }

  .column-hover.shift-right {
    transform: translateX(100%);
  }

  .table th,
  .table td {
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    will-change: transform;
  }

  .column-moving {
    pointer-events: none;
    z-index: 1;
  }
  .drag-preview {
    position: fixed;
    pointer-events: none;
    opacity: 0.7;
    background-color: #fff;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    z-index: 1000;
  }

  /* 修改拖曳指示器樣式 */
  .drop-indicator {
    position: absolute;
    width: 2px;
    background-color: #666;
    pointer-events: none;
    z-index: 1000;
    transition: left 0.3s ease;
  }

  /* 修改拖曳時的列樣式 */
  .dragging-column {
    opacity: 0.5;
    background-color: #f8f9fa;
  }

  /* 修改動畫效果 */
  .table th,
  .table td {
    transition: transform 0.3s ease;
    position: relative;
  }

  /* 防止動畫重複觸發 */
  .animating {
    pointer-events: none;
  }

  /* 拖曳預覽樣式 */
  .drag-preview {
    position: fixed;
    pointer-events: none;
    opacity: 0.7;
    background-color: #fff;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    z-index: 1000;
  }

  /* 添加新的動畫相關樣式 */
  .moving {
    transition: transform 0.3s ease !important;
  }

  .table th.no-transition,
  .table td.no-transition {
    transition: none !important;
  }

  /* 修改動畫相關樣式 */
  .table th,
  .table td {
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    will-change: transform;
  }

  .column-moving {
    pointer-events: none;
    z-index: 1;
  }
</style>
{% endblock %} 
 {% block app_title %}
<!-- 直接打文字即可替換各自應用程式的標題 -->
委託專區 Commission 
{% endblock %} 
{% block app_content %}
<div class="row g-3 mb-4 align-items-center justify-content-between">
  <div class="col-auto">
    <h1 class="app-page-title mb-0">接案總表</h1>
  </div>
  <div class="col-auto">
    <div class="page-utilities">
      <div
        class="row g-2 justify-content-start justify-content-md-end align-items-center"
      >
        <div class="col-auto">
          <select class="form-select w-auto" id="searchSelect">
            <option value="option-1" {% if search_column == 'option-1' %}selected{% endif %}>全部</option>
            <option value="title" {% if search_column == 'title' %}selected{% endif %}>標題</option>
            <option value="category" {% if search_column == 'category' %}selected{% endif %}>販賣項目</option>
            <option value="description" {% if search_column == 'description' %}selected{% endif %}>作品說明</option>
            <option value="worker" {% if search_column == 'worker' %}selected{% endif %}>作者</option>
            <option value="originalFrom" {% if search_column == 'originalFrom' %}selected{% endif %}>關聯原作</option>
            <option value="price" {% if search_column == 'price' %}selected{% endif %}>售價</option>
            <option value="publishTime" {% if search_column == 'publishTime' %}selected{% endif %}>發布時間</option>
            <option value="deadline" {% if search_column == 'deadline' %}selected{% endif %}>到期日</option>
            <option value="status" {% if search_column == 'status' %}selected{% endif %}>案件狀態</option>
            <option value="lastUpdate" {% if search_column == 'lastUpdate' %}selected{% endif %}>最後更新</option>
          </select>
        </div>
        <div class="col-auto">
          <form class="table-search-form row gx-1 align-items-center">
            <div class="col-auto">
              <input
                type="text"
                id="search-orders"
                name="searchorders"
                class="form-control search-orders"
                placeholder="Search"
                value="{{ search_term }}"
              />
            </div>
            <div class="col-auto">
              <button type="submit" class="btn app-btn-primary">搜尋</button>
            </div>
            <div class="col-auto">
              <button
                type="button"
                id="clear-search"
                class="btn app-btn-secondary"
              >
                清除
              </button>
            </div>
          </form>
        </div>
        <!--//col-->

        <!-- 新增接案按鈕 -->
        <!-- 想想「新增接案」應該是綁使用者帳號在新增的，管理者自行新增沒有綁使用者也沒有意義 -->
        <!-- <div class="col-auto">
          <a class="btn app-btn-primary" href="#">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              fill="currentColor"
              class="bi bi-plus-square-dotted"
              viewBox="0 0 16 16"
            >
              <path
                d="M2.5 0q-.25 0-.487.048l.194.98A1.5 1.5 0 0 1 2.5 1h.458V0q0-.151.029-.293zM13.5 0h-.458v1h.458q.151 0 .293.029l.98-.194Q13.75 0 13.5 0m2.079 1.11a2.5 2.5 0 0 0-.69-.689l-.556.831q.248.167.415.415l.83-.556zM1.11.421a2.5 2.5 0 0 0-.689.69l.831.556c.11-.164.251-.305.415-.415l.556-.83zm16 2.5q0-.25-.048-.487l-.98.194q.027.141.028.293v.458h1V2.5q0-.151.029-.293zM.048 2.013A2.5 2.5 0 0 0 0 2.5v.458h1V2.5q0-.151.029-.293zM0 3.875v.917h1v-.917zm16 .917v-.917h-1v.917zm-16 .917v.917h1v-.917zm16 .917v-.917h-1v.917zm-16 .917v.458q0 .25.048.487l.98-.194A1.5 1.5 0 0 1 1 13.5v-.458zm16 .458v-.458q0 .151-.029.293l-.981.194Q16 13.75 16 13.5M.421 14.89c.183.272.417.506.69.689l.556-.831a1.5 1.5 0 0 1-.415-.415zm14.469.689c.272-.183.506-.417.69-.69l-.831-.556c-.11.164-.251.305-.415.415l.556.83zm-12.877.373Q2.25 16 2.5 16h.458v-1H2.5q-.151 0-.293-.029zM13.5 16q.25 0 .487-.048l-.194-.98A1.5 1.5 0 0 1 13.5 15h-.458v1zm-9.625 0h.917v-1h-.917zm1.833 0h.917v-1h-.917zm1.834-1v1h.916v-1zm1.833 1h.917v-1h-.917zm1.833 0h.917v-1h-.917zm1.833 0h.917v-1h-.917zM8.5 4.5a.5.5 0 0 0-1 0v3h-3a.5.5 0 0 0 0 1h3v3a.5.5 0 0 0 1 0v-3h3a.5.5 0 0 0 0-1h-3z"
              />
            </svg>
            新增接案
          </a>
        </div> -->
      </div>
      <!--//row-->
    </div>
    <!--//table-utilities-->
  </div>
  <!--//col-auto-->
</div>
<!--//row-->

<nav
  id="orders-table-tab"
  class="orders-table-tab app-nav-tabs nav shadow-sm flex-column flex-sm-row mb-4"
>
  <a
    class="flex-sm-fill text-sm-center nav-link active"
    id="orders-all-tab"
    data-status="all"
    >所有狀態</a
  >
  <a
    class="flex-sm-fill text-sm-center nav-link"
    id="orders-paid-tab"
    data-status="公開販售"
    >公開販售</a
  >
  <a
    class="flex-sm-fill text-sm-center nav-link"
    id="orders-pending-tab"
    data-status="投稿審查"
    >投稿審查</a
  >
  <a
    class="flex-sm-fill text-sm-center nav-link"
    id="orders-completed-tab"
    data-status="已成交"
    >已成交</a
  >
  <a
    class="flex-sm-fill text-sm-center nav-link"
    id="orders-cancelled-tab"
    data-status="取消販售"
    >取消販售</a
  >
</nav>
<!-- 這裡做勾選控制項篩選要隱藏/顯示的欄位項目 -->
<div class="mb-3">
  <!-- 重置按鈕 -->
  <button type="button" class="btn btn-secondary btn-reset">
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="16"
      height="16"
      fill="currentColor"
      class="bi bi-arrow-clockwise"
      viewBox="0 0 16 16"
    >
      <path
        fill-rule="evenodd"
        d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"
      ></path>
      <path
        d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"
      ></path>
    </svg>
  </button>
  <strong>&nbsp;顯示欄位：</strong>
  <div class="form-check form-check-inline">
    <input class="form-check-input" type="checkbox" id="showTitle" checked />
    <label class="form-check-label" for="showTitle">標題</label>
  </div>
  <div class="form-check form-check-inline">
    <input class="form-check-input" type="checkbox" id="showCategory" checked />
    <label class="form-check-label" for="showCategory">販賣項目</label>
  </div>
  <div class="form-check form-check-inline">
    <input
      class="form-check-input"
      type="checkbox"
      id="showDescription"
      checked
    />
    <label class="form-check-label" for="showDescription">作品說明</label>
  </div>
  <div class="form-check form-check-inline">
    <input class="form-check-input" type="checkbox" id="showWorker" checked />
    <label class="form-check-label" for="showWorker">作者</label>
  </div>
  <div class="form-check form-check-inline">
    <input
      class="form-check-input"
      type="checkbox"
      id="showOriginalFrom"
      checked
    />
    <label class="form-check-label" for="showOriginalFrom">關聯原作</label>
  </div>
  <div class="form-check form-check-inline">
    <input class="form-check-input" type="checkbox" id="showPrice" checked />
    <label class="form-check-label" for="showPrice">售價</label>
  </div>
  <div class="form-check form-check-inline">
    <input
      class="form-check-input"
      type="checkbox"
      id="showPublishTime"
      checked
    />
    <label class="form-check-label" for="showPublishTime">發布時間</label>
  </div>
  <div class="form-check form-check-inline">
    <input class="form-check-input" type="checkbox" id="showDeadline" checked />
    <label class="form-check-label" for="showDeadline">到期日</label>
  </div>
  <div class="form-check form-check-inline">
    <input class="form-check-input" type="checkbox" id="showStatus" checked />
    <label class="form-check-label" for="showStatus">案件狀態</label>
  </div>
  <div class="form-check form-check-inline">
    <input
      class="form-check-input"
      type="checkbox"
      id="showLastUpdate"
      checked
    />
    <label class="form-check-label" for="showLastUpdate">最後更新</label>
  </div>
</div>

<div class="tab-content" id="orders-table-tab-content">
  <div
    class="tab-pane fade show active"
    id="orders-all"
    role="tabpanel"
    aria-labelledby="orders-all-tab"
  >
    <div class="app-card app-card-orders-table shadow-sm mb-5">
      <div class="app-card-body">
        <div class="table-responsive">
          <table class="table app-table-hover mb-0 text-left">
            <thead>
              <tr>
                <th class="cell" data-column="id">ID</th>
                <th class="cell" data-column="title" draggable="true">標題</th>
                <th class="cell" data-column="category" draggable="true">
                  販賣項目
                </th>
                <th class="cell" data-column="description" draggable="true">
                  作品說明
                </th>
                <th class="cell" data-column="worker" draggable="true">
                  作者
                </th>
                <th class="cell" data-column="originalFrom" draggable="true">
                  關聯原作
                </th>
                <th class="cell" data-column="price" draggable="true">售價</th>
                <th class="cell" data-column="publishTime" draggable="true">
                  發布時間
                </th>
                <th class="cell" data-column="deadline" draggable="true">
                  到期日
                </th>
                <th class="cell" data-column="status" draggable="true">
                  案件狀態
                </th>
                <th class="cell" data-column="lastUpdate" draggable="true">
                  最後更新
                </th>
                <th class="cell">編輯</th>
              </tr>
            </thead>
            <tbody>
              {% for HTML_work in page_obj %}
              <tr>
                <td class="cell" data-column="id">{{HTML_work.work_id}}</td>
                <td class="cell" data-column="title">
                  {{HTML_work.work_title}}
                </td>
                <td class="cell" data-column="category">
                  {{HTML_work.work_category}}
                </td>
                <td class="cell" data-column="description">
                  {{HTML_work.work_description|truncatechars:35}}
                </td>
                <td class="cell" data-column="worker">
                  {{HTML_work.public_card.user_nickname}}
                </td>
                <td class="cell" data-column="originalFrom">
                  {{HTML_work.work_original_from}}
                </td>
                <td class="cell" data-column="price">
                  ${{HTML_work.work_price}}
                </td>
                <td class="cell" data-column="publishTime">
                  <span class="cell-data"
                    >{{ HTML_work.publish_time|date:"y-m-d" }}</span
                  >
                  <span class="note"
                    >{{ HTML_work.publish_time|time:"g:i A" }}</span
                  >
                </td>
                <td class="cell" data-column="deadline">
                  <span class="cell-data"
                    >{{ HTML_work.deadline|date:"y-m-d" }}</span
                  >
                  <span class="note"
                    >{{ HTML_work.deadline|time:"g:i A" }}</span
                  >
                </td>
                <td class="cell" data-column="status">
                  <span
                    class="badge {% if HTML_work.work_status == '公開販售' %}bg-success {% elif HTML_work.work_status == '投稿審查' %}bg-danger {% elif HTML_work.work_status == '已成交' %}bg-info {% elif HTML_work.work_status == '取消販售' %}bg-secondary {% endif %}"
                  >
                    {{HTML_work.work_status}}
                  </span>
                </td>
                <td class="cell" data-column="lastUpdate">
                  <span class="cell-data"
                    >{{ HTML_work.last_update|date:"y-m-d" }}</span
                  >
                  <span class="note"
                    >{{ HTML_work.last_update|time:"g:i A" }}</span
                  >
                </td>
                <!-- 編輯鈕 -->
                <td class="cell">
                  <a
                    href="{% url 'commission:Urls_work_edit' HTML_work.work_id %}"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="16"
                      height="16"
                      fill="currentColor"
                      class="bi bi-pencil-square"
                      viewBox="0 0 16 16"
                    >
                      <path
                        d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"
                      ></path>
                      <path
                        fill-rule="evenodd"
                        d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5z"
                      ></path>
                    </svg>
                  </a>&nbsp;
                  <!-- 刪除鈕 -->
                  <a href="{% url 'commission:Urls_work_delete' HTML_work.work_id %}" class="text-danger" onclick="return confirm('您即將要刪除「ID:{{HTML_work.work_id}} {{HTML_work.work_title}}」?')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash3" viewBox="0 0 16 16">
                      <path d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5M11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66h.538a.5.5 0 0 0 0-1zm1.958 1-.846 10.58a1 1 0 0 1-.997.92h-6.23a1 1 0 0 1-.997-.92L3.042 3.5zm-7.487 1a.5.5 0 0 1 .528.47l.5 8.5a.5.5 0 0 1-.998.06L5 5.03a.5.5 0 0 1 .47-.53Zm5.058 0a.5.5 0 0 1 .47.53l-.5 8.5a.5.5 0 1 1-.998-.06l.5-8.5a.5.5 0 0 1 .528-.47M8 4.5a.5.5 0 0 1 .5.5v8.5a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5"/>
                    </svg>
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <!--//table-responsive-->
      </div>
      <!--//app-card-body-->
    </div>
    <!--//app-card-->
    <nav class="app-pagination">
    <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}&search={{ search_term }}&column={{ search_column }}&status={{ status_filter }}&sort={{ sort_column }}&order={{ sort_order }}">上一頁</a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link">上一頁</span>
        </li>
        {% endif %}
        
        {% for num in page_obj.paginator.page_range %}
        {% if page_obj.number == num %}
        <li class="page-item active" aria-current="page">
            <span class="page-link">{{ num }}</span>
        </li>
        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
        <li class="page-item">
            <a class="page-link" href="?page={{ num }}&search={{ search_term }}&column={{ search_column }}&status={{ status_filter }}&sort={{ sort_column }}&order={{ sort_order }}">{{ num }}</a>
        </li>
        {% endif %}
        {% endfor %}
        
        {% if page_obj.has_next %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}&search={{ search_term }}&column={{ search_column }}&status={{ status_filter }}&sort={{ sort_column }}&order={{ sort_order }}">下一頁</a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link">下一頁</span>
        </li>
        {% endif %}
    </ul>
</nav>
    <!--//app-pagination-->
  </div>
  <!--//tab-pane-->
</div>
<!--//tab-content-->
{% endblock %}
{% block app_script %}
<!-- 如果應用程式有自己的JAVA Script放這邊 -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
      const checkboxes = document.querySelectorAll(".form-check-input");
      const resetButton = document.querySelector(".btn-reset");
      let table = document.querySelector('table');
      let draggedColumn = null;
      const initialStates = new Map();

    // 新增篩選功能 
    const statusTabs = document.querySelectorAll('.orders-table-tab .nav-link');
    let currentStatus = '{{ status_filter }}' || 'all'; // 使用後端傳遞的狀態，如果沒有則默認為 'all'

    let sortColumn = '{{ sort_column }}'; // 初始化排序列
    let sortOrder = '{{ sort_order }}'; // 初始化排序順序
// 新增此函數來更狀態標籤的活動狀態
function updateStatusTabs(status) {
        statusTabs.forEach(tab => {
            if (tab.getAttribute('data-status') === status) {
                tab.classList.add('active');
            } else {
                tab.classList.remove('active');
            }
        });
        currentStatus = status;
    }


    // 添加 updateSortIndicator 函數
    function updateSortIndicator(column, order) {
        // 移除所有現有的排序指示器
        document.querySelectorAll('.indicator').forEach(el => el.remove());

        // 為當前排序列添加指示器
        const header = document.querySelector(`th[data-column="${column}"]`);
        if (header) {
            const indicator = document.createElement('span');
            indicator.className = 'indicator';
            indicator.textContent = order === 'asc' ? '▲' : '▼';
            header.appendChild(indicator);
        }
    }

    function bindStatusTabs() {
        statusTabs.forEach(tab => {
            tab.removeEventListener('click', handleStatusTabClick);
            tab.addEventListener('click', handleStatusTabClick);
        });
    }

    function handleStatusTabClick(e) {
        e.preventDefault();
        const status = this.getAttribute('data-status');
        updateStatusTabs(status);
        loadPage(1, searchInput.value, searchSelect.value, status, sortColumn, sortOrder);
    }


      const defaultColumnOrder = [
          'title', 'category', 'description', 'worker', 'originalFrom',
          'price', 'publishTime', 'deadline', 'status', 'lastUpdate'
      ];

      const defaultCheckboxStates = {
          showTitle: true,
          showCategory: true,
          showDescription: true,
          showWorker: true,
          showOriginalFrom: true,
          showPrice: true,
          showPublishTime: true,
          showDeadline: true,
          showStatus: true,
          showLastUpdate: true
      };

      // 切換列的可見性
      function toggleColumnVisibility(checkbox) {
          const column = checkbox.id.replace("show", "");
          const cells = document.querySelectorAll(`[data-column="${column.charAt(0).toLowerCase() + column.slice(1)}"]`);
          cells.forEach((cell) => {
              cell.style.display = checkbox.checked ? "" : "none";
          });
      }

      // 將複選框狀態保存到 localStorage
      function saveCheckboxState(checkbox) {
          localStorage.setItem(checkbox.id, checkbox.checked);
      }

      // 從 localStorage 加載複選框狀態
      function loadCheckboxState(checkbox) {
          const savedState = localStorage.getItem(checkbox.id);
          if (savedState !== null) {
              checkbox.checked = savedState === "true";
          } else {
              checkbox.checked = defaultCheckboxStates[checkbox.id];
          }
      }

      // 保存所有複選框的初始狀態
      function saveInitialStates() {
          checkboxes.forEach((checkbox) => {
              initialStates.set(checkbox.id, defaultCheckboxStates[checkbox.id]);
          });
      }

      // 將所有複選框重置到初始狀態
      function resetCheckboxes() {
          checkboxes.forEach((checkbox) => {
              checkbox.checked = defaultCheckboxStates[checkbox.id];
              toggleColumnVisibility(checkbox);
              saveCheckboxState(checkbox);
          });
          resetColumnOrder();
      }

      // 為每個複選框設置初始狀態和監聽器
      checkboxes.forEach((checkbox) => {
          loadCheckboxState(checkbox);
          toggleColumnVisibility(checkbox);
          checkbox.addEventListener("change", function () {
              toggleColumnVisibility(this);
              saveCheckboxState(this);
          });
      });

      // 為重置按鈕添加點擊事件監聽器
      resetButton.addEventListener("click", resetCheckboxes);

      // 更新分頁處理函數
      function handlePagination() {
          const paginationLinks = document.querySelectorAll('.pagination .page-link');
          paginationLinks.forEach(link => {
              link.removeEventListener('click', handlePaginationClick); // 先移除舊的事件處理器
              link.addEventListener('click', handlePaginationClick); // 再綁定新的事件處理器
          });
      }

      function handlePaginationClick(e) {
          if (!this.hasAttribute('data-page')) return;
          e.preventDefault();
          const page = this.getAttribute('data-page');
          const searchTerm = searchInput.value;
          const searchColumn = searchSelect.value;
          const status = document.querySelector('.orders-table-tab .nav-link.active').getAttribute('data-status');
          loadPage(page, searchTerm, searchColumn, status);
      }

      function applyColumnVisibility() {
          checkboxes.forEach((checkbox) => {
              toggleColumnVisibility(checkbox);
          });
      }

      function loadPage(page, searchTerm = '', searchColumn = 'option-1', status = currentStatus, sort = sortColumn, order = sortOrder) {
        const url = new URL(window.location.href);
        url.searchParams.set('page', page);
        url.searchParams.set('status', status);
        url.searchParams.set('sort', sort);
        url.searchParams.set('order', order);
        if (searchTerm) {
            url.searchParams.set('search', searchTerm);
            url.searchParams.set('column', searchColumn);
        } else {
            url.searchParams.delete('search');
            url.searchParams.delete('column');
        }

        fetch(url)
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                // 更新表格內容
                const content = document.querySelector('.app-card-body');
                content.innerHTML = doc.querySelector('.app-card-body').innerHTML;

                // 更新分頁導航
                const pagination = document.querySelector('.app-pagination');
                pagination.innerHTML = doc.querySelector('.app-pagination').innerHTML;

                // 更新狀態標籤的活動狀態
                updateStatusTabs(status);

                // 重新綁定狀態標事件
                bindStatusTabs();

                // 更新 URL
                history.pushState(null, '', url);

                // 滾動到頁面頂部
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });

                // 重新獲取表格元素
                table = document.querySelector('table');

                // 重新應用列的可見性
                applyColumnVisibility();

                // 重新綁定分頁事件
                handlePagination();

                // 重新應用列順序
                loadColumnOrder();

                // 重新綁定拖放事件
                bindDragAndDrop();

                // 重新綁定搜尋功能
                bindSearch();
                // 重新綁定排序事件
                bindSortEvents();

                // 更新搜尋框和下拉選單的值
                searchInput.value = url.searchParams.get('search') || '';
                searchSelect.value = url.searchParams.get('column') || 'option-1';

                // 更新狀態標籤的活動狀態
                updateStatusTabs(status);

                // 更新排序指示器
                updateSortIndicator(sort, order);

                // 重新綁定狀態標籤事件
                bindStatusTabs();
            });
    }

        // 新增此函數來綁定排序事件
        function bindSortEvents() {
            const headers = document.querySelectorAll('th[data-column]');
            headers.forEach(header => {
                if (header.getAttribute('data-column') !== 'edit') {
                    header.removeEventListener('click', handleColumnClick);
                    header.addEventListener('click', handleColumnClick);
                }
            });
        }
    
      function bindDragAndDrop() {
          const headers = table.querySelectorAll('th[draggable="true"]');
          headers.forEach(header => {
              header.removeEventListener('dragstart', handleDragStart); // 先移除舊的事件處理器
              header.removeEventListener('dragover', handleDragOver);
              header.removeEventListener('dragenter', handleDragEnter);
              header.removeEventListener('dragleave', handleDragLeave);
              header.removeEventListener('drop', handleDrop);
              header.removeEventListener('dragend', handleDragEnd);

              header.addEventListener('dragstart', handleDragStart); // 再綁定新的事件處理器
              header.addEventListener('dragover', handleDragOver);
              header.addEventListener('dragenter', handleDragEnter);
              header.addEventListener('dragleave', handleDragLeave);
              header.addEventListener('drop', handleDrop);
              header.addEventListener('dragend', handleDragEnd);
          });
      }

      let dragIndicator = null;
      let lastEnteredColumn = null;
      let isAnimating = false;

      function createDragIndicator() {
          if (!dragIndicator) {
              dragIndicator = document.createElement('div');
              dragIndicator.className = 'drop-indicator';
              document.body.appendChild(dragIndicator);
          }
          return dragIndicator;
      }

      function updateDragIndicator(target, position) {
          const indicator = createDragIndicator();
          const tableRect = table.getBoundingClientRect();
          const targetRect = target.getBoundingClientRect();
          
          indicator.style.top = `${tableRect.top}px`;
          indicator.style.height = `${tableRect.height}px`;
          
          if (position === 'left') {
              indicator.style.left = `${targetRect.left}px`;
          } else {
              indicator.style.left = `${targetRect.right}px`;
          }
      }

      function removeDragIndicator() {
          if (dragIndicator) {
              dragIndicator.remove();
              dragIndicator = null;
          }
      }

      function handleDragStart(e) {
          const columnIndex = Array.from(this.parentNode.children).indexOf(this);
          draggedColumn = this;
          
          // 設置拖曳圖像
          const dragPreview = document.createElement('div');
          dragPreview.className = 'drag-preview';
          dragPreview.style.width = `${this.offsetWidth}px`;
          dragPreview.style.height = `${table.offsetHeight}px`;
          dragPreview.innerHTML = this.outerHTML;
          
          document.body.appendChild(dragPreview);
          e.dataTransfer.setDragImage(dragPreview, 0, 0);
          
          setTimeout(() => {
              document.body.removeChild(dragPreview);
          }, 0);
      }

      function handleDragOver(e) {
          e.preventDefault();
          
          const th = e.target.closest('th');
          if (!th || th === draggedColumn) return;

          const rect = th.getBoundingClientRect();
          const mouseX = e.clientX;
          const position = mouseX - rect.left < rect.width / 2 ? 'left' : 'right';
          
          updateDragIndicator(th, position);
      }

      function handleColumnShift(targetColumn, position) {
          if (isAnimating) return;
          
          const draggedIndex = Array.from(targetColumn.parentNode.children).indexOf(draggedColumn);
          const targetIndex = Array.from(targetColumn.parentNode.children).indexOf(targetColumn);
          
          // 重置所有transform
          const allCells = table.querySelectorAll('td, th');
          allCells.forEach(cell => {
              cell.style.transform = '';
          });

          // 應用新的transform
          const rows = Array.from(table.querySelectorAll('tr'));
          rows.forEach(row => {
              const cells = Array.from(row.children);
              
              if (draggedIndex < targetIndex) {
                  // 向右拖曳時
                  cells.forEach((cell, index) => {
                      if (index === draggedIndex) {
                          // 被拖曳的欄位
                          const offset = position === 'left' ? 
                              (targetIndex - draggedIndex - 1) * 100 : 
                              (targetIndex - draggedIndex) * 100;
                          cell.style.transform = `translateX(${offset}%)`;
                      } else if (index > draggedIndex && index <= targetIndex) {
                          // 中間的欄位向左移
                          cell.style.transform = 'translateX(-100%)';
                      }
                  });
              } else {
                  // 向左拖曳時
                  cells.forEach((cell, index) => {
                      if (index === draggedIndex) {
                          // 被拖曳的欄位
                          const offset = position === 'left' ? 
                              (targetIndex - draggedIndex) * 100 : 
                              (targetIndex - draggedIndex + 1) * 100;
                          cell.style.transform = `translateX(${offset}%)`;
                      } else if (index >= targetIndex && index < draggedIndex) {
                          // 中間的欄位向右移
                          cell.style.transform = 'translateX(100%)';
                      }
                  });
              }
          });
      }

      function handleDragEnter(e) {
          e.preventDefault();
      }

      function handleDragLeave(e) {
          const relatedTarget = e.relatedTarget;
          if (!table.contains(relatedTarget)) {
              removeDragIndicator();
              resetColumnPositions();
          }
      }

      function resetColumnPositions() {
          const cells = table.querySelectorAll('td, th');
          cells.forEach(cell => {
              cell.style.transform = '';
          });
          lastEnteredColumn = null;
      }

      function handleDrop(e) {
          e.preventDefault();
          
          const th = e.target.closest('th');
          if (!th || th === draggedColumn) return;

          const fromIndex = Array.from(draggedColumn.parentNode.children).indexOf(draggedColumn);
          const toIndex = Array.from(th.parentNode.children).indexOf(th);
          
          moveColumn(fromIndex, toIndex);
          resetColumnPositions();
          removeDragIndicator();
      }

      function handleDragEnd() {
          resetColumnPositions();
          removeDragIndicator();
          
          const cells = table.querySelectorAll('.dragging-column');
          cells.forEach(cell => {
              cell.classList.remove('dragging-column');
              cell.style.visibility = 'visible';
          });
      }

      function moveColumn(fromIndex, toIndex) {
    if (fromIndex === toIndex) return;
    
    const rows = Array.from(table.querySelectorAll('tr'));
    const direction = fromIndex < toIndex ? 1 : -1;
    const offset = direction * 100;

    // 應用動畫
    rows.forEach(row => {
        const cells = Array.from(row.children);
        
        // 移動拖曳的欄位
        const movingCell = cells[fromIndex];
        movingCell.style.transform = `translateX(${(toIndex - fromIndex) * 100}%)`;
        movingCell.classList.add('column-moving');

        // 移動其他受影響的欄位
        for (let i = Math.min(fromIndex, toIndex); i <= Math.max(fromIndex, toIndex); i++) {
            if (i !== fromIndex) {
                const cell = cells[i];
                cell.style.transform = `translateX(${-direction * 100}%)`;
                cell.classList.add('column-moving');
            }
        }
    });

          // 在動畫結束後重新排序 DOM
    setTimeout(() => {
        rows.forEach(row => {
            const cells = Array.from(row.children);
            const [movingCell] = cells.splice(fromIndex, 1);
            cells.splice(toIndex, 0, movingCell);
            
            // 重置所有樣式
            cells.forEach(cell => {
                cell.style.transform = '';
                cell.classList.remove('column-moving');
            });
            
            // 更新 DOM
            row.innerHTML = '';
            cells.forEach(cell => row.appendChild(cell));
        });
        
        saveColumnOrder();
    }, 300);
}

      function showDropIndicator(element) {
          const indicator = document.createElement('div');
          indicator.className = 'drop-indicator';
          indicator.style.position = 'absolute';
          indicator.style.top = '0';
          indicator.style.bottom = '0';
          indicator.style.width = '4px';
          indicator.style.backgroundColor = '#007bff';
          indicator.style.left = `${element.offsetLeft - 2}px`;
          table.parentNode.appendChild(indicator);
      }

      function hideDropIndicator() {
          const indicator = document.querySelector('.drop-indicator');
          if (indicator) {
              indicator.remove();
          }
      }

      function saveColumnOrder() {
          const order = Array.from(table.querySelectorAll('th[draggable="true"]'))
              .map(th => th.getAttribute('data-column'));
          localStorage.setItem('columnOrder', JSON.stringify(order));
      }

      function loadColumnOrder() {
          const savedOrder = localStorage.getItem('columnOrder');
          if (savedOrder) {
              const order = JSON.parse(savedOrder);
              applyColumnOrder(order);
          } else {
              resetColumnOrder();
          }
      }

      function applyColumnOrder(order) {
          const thead = table.querySelector('thead tr');
          const tbody = table.querySelector('tbody');
          const headers = Array.from(thead.querySelectorAll('th[draggable="true"]'));
          const rows = Array.from(tbody.children);

          order.forEach((columnName, index) => {
              const header = headers.find(h => h.getAttribute('data-column') === columnName);
              if (header) {
                  thead.insertBefore(header, thead.children[index + 1]); // +1 因為第一列是固定的
              }
              rows.forEach(row => {
                  const cell = row.querySelector(`td[data-column="${columnName}"]`);
                  if (cell) {
                      row.insertBefore(cell, row.children[index + 1]); // +1 因為第一列是固定的
                  }
              });
          });
      }

      function resetColumnOrder() {
          applyColumnOrder(defaultColumnOrder);
          localStorage.removeItem('columnOrder');
      }

      // 新增搜尋功能
      const searchForm = document.querySelector('.table-search-form');
      const searchInput = document.getElementById('search-orders');
      const searchSelect = document.querySelector('.form-select');
      const clearSearchButton = document.getElementById('clear-search');

      function bindSearch() {
          searchForm.removeEventListener('submit', handleSearchSubmit); // 先移除舊的事件處理器
          searchForm.addEventListener('submit', handleSearchSubmit); // 再綁定新的事件處理器

          clearSearchButton.removeEventListener('click', handleClearSearch); // 先移除舊的事件處理器
          clearSearchButton.addEventListener('click', handleClearSearch); // 再綁定新的事件處理器
      }

      function handleSearchSubmit(e) {
          e.preventDefault();
          performSearch();
      }

      function handleClearSearch() {
          searchInput.value = '';
          searchSelect.value = 'option-1';
          performSearch();
      }

      function performSearch() {
          const searchTerm = searchInput.value;
          const searchColumn = searchSelect.value;
          const status = document.querySelector('.orders-table-tab .nav-link.active').getAttribute('data-status');
          loadPage(1, searchTerm, searchColumn, status, sortColumn, sortOrder);
      }

      // 新增篩選功能
      // const statusTabs = document.querySelectorAll('.orders-table-tab .nav-link');
      // let currentStatus = 'all'; // 添加這行來跟踪當前狀態
      // statusTabs.forEach(tab => {
      //   tab.addEventListener('click', function (e) {
      //     e.preventDefault();
      //     const status = this.getAttribute('data-status');
      //     loadPage(1, searchInput.value, searchSelect.value, status);
      //   });
      // });

       // 新增此函數來處理欄位點擊事件
      function handleColumnClick(e) {
      const column = e.target.closest('th');
      if (!column || column.getAttribute('data-column') === 'edit') return;

      const columnName = column.getAttribute('data-column');
      let newOrder = 'desc';  // 默認為降序

      // 檢查當前列是否已經排序
      if (columnName === '{{ sort_column }}') {
        newOrder = '{{ sort_order }}' === 'desc' ? 'asc' : 'desc';
      }

      performSort(columnName, newOrder);
    }

    function performSort(column, order) {
            sortColumn = column;
            sortOrder = order;
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('sort', column);
            currentUrl.searchParams.set('order', order);
            currentUrl.searchParams.set('page', '1');  // 重置到第頁

            // 保留其他查詢參數
            const searchTerm = currentUrl.searchParams.get('search');
            const searchColumn = currentUrl.searchParams.get('column');
            const statusFilter = currentUrl.searchParams.get('status');

            if (searchTerm) currentUrl.searchParams.set('search', searchTerm);
            if (searchColumn) currentUrl.searchParams.set('column', searchColumn);
            if (statusFilter) currentUrl.searchParams.set('status', statusFilter);
            
            window.location.href = currentUrl.toString();
            loadPage(1, searchTerm, searchColumn, statusFilter, sortColumn, sortOrder);
        }


    // 綁定點擊事件到所有可排序的欄位
    const headers = document.querySelectorAll('th[data-column]');
    headers.forEach(header => {
      if (header.getAttribute('data-column') !== 'edit') {
        header.addEventListener('click', handleColumnClick);
      }
    });
// 初始化排序指示器
function initSortIndicator() {
    const sortColumn = '{{ sort_column }}';
    const sortOrder = '{{ sort_order }}';
    const isSorted = {{ is_sorted|yesno:"true,false" }};
    if (isSorted && sortColumn) {
        const header = document.querySelector(`th[data-column="${sortColumn}"]`);
        if (header) {
            const indicator = document.createElement('span');
            indicator.className = 'indicator';
            indicator.textContent = sortOrder === 'asc' ? '▲' : '▼';
            header.appendChild(indicator);
            }
        }
    }

    // 更新分頁鏈接
    function updatePaginationLinks() {
      const paginationLinks = document.querySelectorAll('.pagination a');
      paginationLinks.forEach(link => {
        const url = new URL(link.href, window.location.origin);
        url.searchParams.set('sort', '{{ sort_column }}');
        url.searchParams.set('order', '{{ sort_order }}');

        // 保留其他查詢參數
        const searchTerm = new URL(window.location.href).searchParams.get('search');
        const searchColumn = new URL(window.location.href).searchParams.get('column');
        const statusFilter = new URL(window.location.href).searchParams.get('status');

        if (searchTerm) url.searchParams.set('search', searchTerm);
        if (searchColumn) url.searchParams.set('column', searchColumn);
        if (statusFilter) url.searchParams.set('status', statusFilter);

        link.href = url.toString();
      });
    }

    initSortIndicator();
    updatePaginationLinks();

    
      // 初始化函數
      function init() {
    if (table) {
        bindDragAndDrop();
        loadColumnOrder();
    } else {
        console.error('Table not found');
    }

    // 初始綁定分頁事件
    handlePagination();

    // 初始應用列的可見性
    applyColumnVisibility();

    // 保存初始狀態
    saveInitialStates();

    // 初始綁定搜尋功能
    bindSearch();

    // 初始化排序指示器
    updateSortIndicator(sortColumn, sortOrder);

    // 初始更狀態標籤
    updateStatusTabs(currentStatus);

    // 初始綁定狀態標籤事件
    bindStatusTabs();

    // 初始綁定排序事件
    bindSortEvents();
}

        // 執行初始化
        init();
    });
</script>
{% endblock %}
