{# {% extends '[BASE]ALL.html' %} #}
{% load static %} 
{% block app_css %}
<style>

  /* 發起過的需求 - 需求小卡樣式 */
  .need-card {
    width: 240px; 
    flex: 0 0 auto;
  }

  /* 需求小卡容器樣式 */
  .need-card-container {
    position: relative; /* 為遮罩層提供定位基準 */
    border: 1px solid #ccc;
    border-radius: 5px;
    overflow: hidden;
    margin-top: 10px;
    /* box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); 添加陰影效果 */
  }

  /* 遮罩層樣式 */
  .need-card-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0); /* 初始透明 */
    pointer-events: none; /* 允許點擊穿透 */
    transition: background-color 0.3s ease; /* 添加過渡效果 */
    z-index: 1; /* 確保遮罩在內容之上 */
  }

  /* 非公開狀態的遮罩層 */
  .need-card-container.private .need-card-overlay {
    background-color: rgba(0, 0, 0, 0.2); /* 半透明黑色 */
  }

  /* 需求小卡標題樣式 - 深色版本 */
  .need-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 5px;
  }

  /* 需求小卡內容樣式 - 淺色版本 */
  .need-card-body {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    height: 100px;
  }

  /* 徵件中狀態 */
  .need-card-header.status-recruiting {
    background-color: #b8e7be; 
  }
  .need-card-body.status-recruiting {
    background-color: #ebf8ec;
  }

  /* 截止狀態 */
  .need-card-header.status-closed {
    background-color: #f3cdcd; 
  }
  .need-card-body.status-closed {
    background-color: #fcecec;
  }

  /* 已成交狀態 */
  .need-card-header.status-completed {
    background-color: #d6e8f9;
  }
  .need-card-body.status-completed {
    background-color: #eef4fc;
  }

  /* 取消徵件狀態 */
  .need-card-header.status-cancelled {
    background-color: #CECECE;
  }
  .need-card-body.status-cancelled {
    background-color: #F0F0F0; 
  }

  /* 需求小卡標題樣式 */
  .need-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 5px;
  }

  /* 需求小卡標題文字樣式 */
  .need-card-title {
    margin: 0;
    font-size: 16px;
    font-weight: bold;
  }

  /* 需求小卡內容樣式 - 確保固定高度 */
  .need-card-body {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    height: 100px; /* 設定固定高度 */
  }

  /* 需求小卡描述樣式 */
  .need-card-description {
    flex: 1;
  }

  /* 需求小卡描述文字樣式 */
  .need-card-text {
    margin-top: 5px; /* 內文與標題間距 */
    font-size: 14px;
    color: #555;
  }

  /* 需求小卡預覽圖容器樣式 */
  .need-card-preview {
    width: 80%;
    height: 110%;
    /* background-color: #d0d0d0; */
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden; /* 防止圖片溢出 */
    margin-left: 5px;
  }

  /* 需求小卡預覽圖片樣式 */
  .need-card-preview img {
    width: auto; /* 自動寬度 */
    height: auto; /* 自動高度 */
    max-width: 100%; /* 最大寬度 */
    max-height: 100%; /* 最大高度 */
    object-fit: contain; /* 保持原圖比例 */
  }

  /* 需求小卡公開狀態樣式 */
  .need-card-status {
    padding: 10px;
    display: flex;
    justify-content: center;
    gap: 5px;
  }

  /* 需求小卡公開狀態標籤樣式 */
  .need-card-status .form-check-label {
    font-size: 0.75em;
  }

    /* 委託狀態 radio 按鈕樣式 */
    input.form-check-input.need-list-radio {
    position: static; /* 覆蓋 .right-section .form-check-input 的定位 */
    right: auto;
    top: auto;
    transform: none;
  }
</style>
{% endblock %}

{% block app_content %}
<li>
    <div class="d-flex justify-content-between align-items-center">
      <label
        class="form-check-label form-label me-2"
        for="switch-need-list"
        >發起過的需求<span
          class="ms-2"
          data-bs-container="body"
          data-bs-toggle="popover"
          data-bs-trigger="hover focus"
          data-bs-placement="top"
          data-bs-content="公開狀態僅控制是否顯示在名片上，不影響是否公開於大廳"
          ><svg
            width="1em"
            height="1em"
            viewBox="0 0 16 16"
            class="bi bi-info-circle"
            fill="currentColor"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              fill-rule="evenodd"
              d="M8 15A7 7 0 1 0 8 1a7 7 0 0 0 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"
            />
            <path
              d="M8.93 6.588l-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588z"
            />
            <circle cx="8" cy="4.5" r="1" /></svg></span
      ></label>
      <div class="form-check form-switch">
        <input
          class="form-check-input"
          type="checkbox"
          id="switch-need-list"
          checked
        />
      </div>
    </div>
    <div class="private-message" style="display: none;">
      <div class="text-muted text-center py-3">使用者未開放資訊</div>
    </div>
    <div class="expandable-content" id="content-need-list">
      <div class="public-content">
        <div class="d-flex flex-row flex-wrap gap-3">
          {% if ViewKey_DbNeedInfo %} 
          {% for HTML_need in ViewKey_DbNeedInfo %}
          <div class="need-card">
            <!-- 加入隱藏的偵錯資訊 -->
            <div style="display: none;" 
                 data-debug="true"
                 data-need-id="{{ HTML_need.need_id }}"
                 data-public-status="{{ HTML_need.public_status|lower }}">
            </div>
            
            <div
              class="need-card-container {% if not HTML_need.public_status %}private{% endif %}"
            >
              <div class="need-card-overlay"></div>
              <!-- 上層DIV -->
              <div class="need-card-header 
                  {% if HTML_need.need_status == '徵件中' %}status-recruiting
                  {% elif HTML_need.need_status == '截止' %}status-closed
                  {% elif HTML_need.need_status == '已成交' %}status-completed
                  {% elif HTML_need.need_status == '取消徵件' %}status-cancelled{% endif %}">
                <div style="display: flex; flex-direction: column;">
                  <h5 class="need-card-title">{{ HTML_need.need_title }}</h5>
                  {% if HTML_need.need_original_from %}
                  <p class="need-card-text small text-muted" style="margin-bottom: 0; font-size: 0.75em; margin: 2px  0 0 6px;">
                    原作：{{ HTML_need.need_original_from }}
                  </p>
                  {% endif %}
                </div>
                <span
                class="badge {% if HTML_need.need_status == '徵件中' %}bg-success {% elif HTML_need.need_status == '截止' %}bg-danger {% elif HTML_need.need_status == '已成交' %}bg-info {% elif HTML_need.need_status == '取消徵件' %}bg-secondary {% endif %}"
              >
                {{HTML_need.need_status}}
              </span>
              </div>
              <!-- 下層DIV -->
              <!-- 依徵件狀態決定顯色 -->
              <div class="need-card-body
                  {% if HTML_need.need_status == '徵件中' %}status-recruiting
                  {% elif HTML_need.need_status == '截止' %}status-closed
                  {% elif HTML_need.need_status == '已成交' %}status-completed
                  {% elif HTML_need.need_status == '取消徵件' %}status-cancelled{% endif %}">
                {% with first_need_image=HTML_need.dbneedimages_set.all|first %} 
                {% if first_need_image %}
                <!-- 需求說明  -->
                <div class="need-card-description" style="flex: 0 1 auto; display: flex; flex-direction: column; justify-content: space-between; height: 100%;">
                  <p class="need-card-text">
                    {{ HTML_need.need_description|truncatechars:16 }}
                  </p>
                  <!-- 更新時間 -->
                  <p class="need-card-text small text-muted" style="margin-bottom: 0; text-align: right; font-size: 0.75em;">
                    {{ HTML_need.last_update|date:"Y.m.d" }}
                  </p>
                </div>
                <!-- 需求預覽圖 -->
                <div class="need-card-preview">
                  <img
                    src="{{ MEDIA_URL }}commission/needID_img/{{ first_need_image.image_url }}"
                    alt="需求預覽圖"
                    style="object-fit: contain; width: 100%; height: 100%;"
                  />
                </div>
                {% else %}
                <!-- 需求說明 -->
                <div class="need-card-description" style="flex: 1; display: flex; flex-direction: column; justify-content: space-between; height: 100%;">
                  <p class="need-card-text">
                    {{ HTML_need.need_description|truncatechars:30 }}
                  </p>
                  <!-- 更新時間 -->
                  <p class="need-card-text small text-muted" style="margin-bottom: 0; text-align: right; font-size: 0.75em;">
                    {{ HTML_need.last_update|date:"Y.m.d" }}
                  </p>
                </div>
                {% endif %} 
                {% endwith %}
              </div>
            </div>
            <!-- 公開狀態切換 -->
            <div class="need-card-status">
              <div class="form-check">
                <label
                  class="form-check-label badge bg-success"
                  for="status{{ HTML_need.need_id }}_public"
                >
                  公開
                </label>
                <input
                  class="form-check-input need-list-radio mx-2"
                  type="radio"
                  name="needStatus{{ HTML_need.need_id }}"
                  id="status{{ HTML_need.need_id }}_public"
                  onchange="handleVisibilityChange(this, {{ HTML_need.need_id }})"
                  {% if HTML_need.public_status %}checked{% endif %}
                />
              </div>
              <div class="form-check">
                <label
                  class="form-check-label badge bg-secondary"
                  for="status{{ HTML_need.need_id }}_private"
                >
                  非公開
                </label>
                <input
                  class="form-check-input need-list-radio mx-2"
                  type="radio"
                  name="needStatus{{ HTML_need.need_id }}"
                  id="status{{ HTML_need.need_id }}_private"
                  onchange="handleVisibilityChange(this, {{ HTML_need.need_id }})"
                  {% if not HTML_need.public_status %}checked{% endif %}
                />
              </div>
            </div>
          </div>
          {% endfor %} {% else %}
          <div class="text-muted">使用者未有發起過的需求</div>
          {% endif %}
        </div>
        <!-- 結束水平排列的 div -->
      </div>
    </div>
  </li>
{% endblock %}


{% block app_script %}
<!-- 如果應用程式有自己的JAVA Script放這邊 -->
<script>
    //       // === 原卡片狀態初始化 ===
//   const radios = document.querySelectorAll(".need-list-radio:checked");
//   radios.forEach((radio) => {
//     handleVisibilityChange(radio, radio.id.match(/\d+/)[0]);
//   });

//   // 初始化需求卡片的公開狀態
//   const needCards = document.querySelectorAll('.need-card');
//   needCards.forEach(card => {
//     const publicRadio = card.querySelector('input[id$="_public"]');
//     const privateRadio = card.querySelector('input[id$="_private"]');
//     const container = card.querySelector('.need-card-container');
    
//     if (publicRadio && privateRadio && container) {
//       // 根據選中的 radio 設置初始狀態
//       if (privateRadio.checked) {
//         container.classList.add('private');
//       } else {
//         container.classList.remove('private');
//       }
//     }
//   });


// // 檢查所有需求卡片的初始狀態
// const allNeedCards = document.querySelectorAll('.need-card');
// allNeedCards.forEach(card => {
//   const debugInfo = card.querySelector('[data-debug="true"]');
//   if (debugInfo) {
//     const needId = debugInfo.dataset.needId;
//     const dbPublicStatus = debugInfo.dataset.publicStatus === 'true';
    
//     const publicRadio = card.querySelector(`#status${needId}_public`);
//     const privateRadio = card.querySelector(`#status${needId}_private`);
    
//     console.log(`需求 ID: ${needId}`, {
//       '資料庫狀態': dbPublicStatus,
//       '公開按鈕狀態': publicRadio ? publicRadio.checked : 'not found',
//       '非公開按鈕狀態': privateRadio ? privateRadio.checked : 'not found'
//     });
//   }
// });

// // 初始化需求卡片的公開狀態
// allNeedCards.forEach(card => {
//   const debugInfo = card.querySelector('[data-debug="true"]');
//   if (debugInfo) {
//     const needId = debugInfo.dataset.needId;
//     const dbPublicStatus = debugInfo.dataset.publicStatus === 'true';
    
//     const publicRadio = card.querySelector(`#status${needId}_public`);
//     const privateRadio = card.querySelector(`#status${needId}_private`);
//     const container = card.querySelector('.need-card-container');
    
//     if (publicRadio && privateRadio && container) {
//       // 強制設置為資料庫狀態
//       publicRadio.checked = dbPublicStatus;
//       privateRadio.checked = !dbPublicStatus;
      
//       // 設置卡片視覺狀態
//       if (!dbPublicStatus) {
//         container.classList.add('private');
//       } else {
//         container.classList.remove('private');
//       }
//     }
//   }
// });

//   // === 原 handleVisibilityChange 函數，處理卡片可見性 ===
//   window.handleVisibilityChange = function(radio, needId) {
//   console.log('狀態變更:', {
//     '需求 ID': needId,
//     '新狀態': radio.id === `status${needId}_public` ? '公開' : '非公開'
//   });
  
//   const container = radio.closest('.need-card').querySelector('.need-card-container');
//   if (container) {
//     if (radio.id === `status${needId}_private`) {
//       container.classList.add('private');
//     } else {
//       container.classList.remove('private');
//     }
//   }
// };
  document.addEventListener('DOMContentLoaded', function() {
    // 監聽 'DOMContentLoaded' 事件，確保在 HTML 文件完全加載後執行
    window.handleVisibilityChange = function(radio, needId) {
      // 定義全局函數 handleVisibilityChange，用於處理可見性變更
      // radio: 觸發事件的 radio 按鈕元素
      // needId: 與 radio 按鈕關聯的需求 ID

    //   console.log('狀態變更:', {
    //     // 在控制台輸出狀態變更的日誌信息
    //     '需求 ID': needId, // 輸出需求 ID
    //     '新狀態': radio.id === `status${needId}_public` ? '公開' : '非公開' // 根據 radio 的 id 判斷新狀態是公開還是非公開
    //   });

      const container = radio.closest('.need-card').querySelector('.need-card-container');
      // 向上查找最近的祖先元素 '.need-card'，然後在其內部選取子元素 '.need-card-container'
      // 這樣可以找到與觸發事件的 radio 按鈕相關聯的卡片容器

      if (container) {
        // 檢查是否成功找到卡片容器元素
        if (radio.id === `status${needId}_private`) {
          // 判斷觸發事件的 radio 按鈕是否為 "非公開" 狀態的 radio
          container.classList.add('private');
          // 如果是非公開，則為卡片容器添加 'private' class，觸發 CSS 樣式，使其顯示為非公開狀態 (例如添加半透明遮罩)
        } else {
          container.classList.remove('private');
          // 如果不是非公開 (即公開)，則移除卡片容器的 'private' class，使其恢復為公開狀態
        }
      }
    };
  });
</script>
{% endblock %}
