{% extends '[BASE]ALL.html' %} 
{% load static %}
{% block app_css %}
<!-- 如果應用程式有自己的css放這邊 -->
<style>
    /* 隱藏頂端列 */
    .app-header-inner {
      display: none;
    }
    /* 取消主板 .app 的 padding-top 設置 */
    .app {
      padding-top: 0 !important;
    }

    .worker-info-card {
      background: linear-gradient(45deg, #f5fdfc, #eefaf1, #edf0c5);
      border: 2px dashed #c4c4c4;
      border-radius: 10px;
    }

    /* 新增CSS樣式 */
    .app-card-settings {
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      height: 100%;
    }

    .content-wrapper {
      flex-shrink: 0;
    }

    .image-upload-placeholder {
      width: calc(33.33% - 10px);
      height: 100px;
      background-color: #e0e0e0;
      border-radius: 5px;
      cursor: pointer;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    .image-preview-wrapper {
        position: relative;
        display: flex; /* 使用 flex 來垂直置中 */
        justify-content: center; /* 水平置中 */
        align-items: center; /* 垂直置中 */
        margin-right: 10px;
        margin-bottom: 10px;
        border-radius: 5px; /* 確保wrapper也有圓角 */
        overflow: hidden; /* 防止內容溢出圓角 */
    }

    .image-preview-wrapper img {
        position: relative;
        max-width: 100%;
        max-height: 100%;
        object-fit: cover;
        border-radius: 5px;
    }

  .icon-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: space-around;
    align-items: center;
    opacity: 0;
    transition: opacity 0.3s;
    background-color: rgba(0, 0, 0, 0.26);
    border-radius: 5px;
    user-select: none;
    cursor: default;
  }

  .image-preview-wrapper:hover .icon-container {
    opacity: 1;
  }

  .icon-button {
    background: rgba(255, 255, 255, 0.418);
    border: none;
    cursor: pointer;
    border-radius: 50%;
    width: 40px;  /* 設置固定寬度 */
    height: 40px; /* 設置固定高度,與寬度相同 */
    display: flex;
    justify-content: center;
    align-items: center;
    transition: background-color 0.3s, transform 0.2s;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
  }

  .icon-button:hover {
    background-color: rgba(255, 255, 255, 0.8);
    transform: scale(1.1);
  }

  .icon-button svg {
    color: #333;  /* 深色圖標 */
    width: 20px;
    height: 20px;
  }

  .tooltip {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(0, 0, 0, 0.75);
    color: white;
    padding: 5px;
    border-radius: 5px;
    white-space: nowrap;
    font-size: 12px;
    display: none;
  }

  .icon-button:hover .tooltip {
    display: block;
  }
  /* 新增模態框的樣式 */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1050; /* 確保在導航選單之上 */
  }

  .modal-image {
    max-width: 90%;
    max-height: 90%;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
  }

  .tree-line {
    display: flex;
    align-items: center;
  }

  .tree-indent {
    flex-shrink: 0;
  }

  .tree-filename {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 150px;
  }

  .overflow-trigger {
    background-color: #f8f9fa;
    border-radius: 4px;
    padding: 2px 8px;
    transition: background-color 0.2s;
  }
  .overflow-trigger:hover {
    background-color: #e9ecef;
  }
</style>
{% endblock %} 
{% block app_title %}
<!-- 直接打文字即可替換各自應用程式的標題 -->
接案編輯 (案件ID：{{ ViewKey_DbWorkInfo_work_id.work_id }})
{% endblock %} 
{% block app_content %}
<div class="row g-4 settings-section">

  <div class="col-12 col-md-8">
    <div class="app-card app-card-settings shadow-sm p-4" style="min-height: 100%;">
      <div class="app-card-body">
        <form class="settings-form" method="post" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="mb-3">
            <label for="setting-input-1" class="form-label">作品標題 (50字內)<span class="ms-2" data-bs-container="body" data-bs-toggle="popover" data-bs-trigger="hover focus" data-bs-placement="top" data-bs-content="10字後的字元會於字卡省略，關係到搜尋曝光率，標題黨站出來！"><svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-info-circle" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" d="M8 15A7 7 0 1 0 8 1a7 7 0 0 0 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                <path d="M8.93 6.588l-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588z"/>
                <circle cx="8" cy="4.5" r="1"/>
              </svg></span>
            </label>
            <input type="text" class="form-control" id="setting-input-1" name="work_title" value="{{ ViewKey_DbWorkInfo_work_id.work_title }}" required maxlength="50">
          </div>
          <div class="mb-3">
            <label for="setting-input-2" class="form-label">作品種類</label>
            <input type="text" class="form-control" id="setting-input-2" name="work_category" value="{{ ViewKey_DbWorkInfo_work_id.work_category }}" required>
          </div>
          <div class="mb-3">
            <label for="setting-input-3" class="form-label">作品說明</label>
            <textarea class="form-control" id="setting-input-3" name="work_description" style="height: 110px;" required>{{ ViewKey_DbWorkInfo_work_id.work_description }}</textarea>
          </div>
          <div class="mb-3">
            <label for="setting-input-4" class="form-label">關聯原作</label>
            <input type="text" class="form-control" id="setting-input-4" name="work_original_from" value="{{ ViewKey_DbWorkInfo_work_id.work_original_from }}" maxlength="150">
          </div>
          <div class="mb-3">
            <label for="setting-input-9" class="form-label">使用限制</label>
            <input type="text" class="form-control" id="setting-input-9" name="usage_restrictions" value="{{ ViewKey_DbWorkInfo_work_id.usage_restrictions }}" maxlength="150">
          </div>
          <div class="mb-3">
            <label for="setting-input-10" class="form-label">Tag</label><span class="text-muted small ms-2" style="font-weight: normal; font-size: 0.8em;">以半形逗號,區隔</span>
            <input type="text" class="form-control" id="setting-input-10" name="tags" value="{{ ViewKey_DbWorkInfo_work_id.tags }}" maxlength="100">
          </div>
          <div class="mb-3">
              <label for="setting-input-6" class="form-label">售價</label>
              <input type="number" class="form-control" id="setting-input-6" name="work_price" value="{{ ViewKey_DbWorkInfo_work_id.work_price }}" step="1" min="0">
            </div>
            <!-- <div class="mb-3">
                <label for="setting-input-7" class="form-label">投稿審查時間</label>
                <input type="datetime-local" class="form-control" id="setting-input-7" name="deadline" value="{{ ViewKey_DbWorkInfo_work_id.deadline|date:'Y-m-d\TH:i' }}">
            </div> -->
            <div class="mb-3">
              <label for="setting-input-7" class="form-label">作品原始檔上傳</label>
              <input type="file" class="form-control" id="setting-input-7" name="original_files" accept="*" multiple>
              <!-- 新增隱藏欄位用於追蹤被刪除的原始檔案 -->
              <input type="hidden" name="deleted_original_files" id="deleted-original-files">
              <!-- 追蹤檔名修改的隱藏欄位 -->
              <input type="hidden" id="renamed-files" name="renamed_files" value="">
              <div id="fileInfo" class="mt-2" style="font-size: 0.9em; color: #666;">
                <!-- 檔案資訊將在這裡動態顯示 -->
              </div>
            </div>
            <div class="mb-3">
              <label for="setting-input-5" class="form-label">作品預覽圖(最多5張)</label>
              <input type="file" class="form-control" id="setting-input-5" name="work_ex_image" accept="image/*" multiple>
            </div>
            <div class="mb-3">
              <label for="setting-input-11" class="form-label">投稿需求案id</label>
              <div class="position-relative d-flex align-items-center gap-3">
                <input type="text" class="form-control" id="setting-input-11" name="case_by_need" value="{{ ViewKey_DbWorkInfo_work_id.case_by_need }}" maxlength="150" autocomplete="off" style="width: 20%; min-width: 150px;">
                <span id="needTitleDisplay">載入中...</span>
                <div id="needInfoPopup" class="position-absolute bg-white shadow rounded p-3" style="display: none; width: 100%; max-height: 300px; overflow-y: auto; z-index: 1000; top: 100%; left: 0;">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th style="width: 50px"></th>
                        <th>需求案ID</th>
                        <th>標題</th>
                        <th>分類</th>
                        <th>原作</th>
                      </tr>
                    </thead>
                    <tbody id="needInfoTableBody">
                    </tbody>
                  </table>
                </div>
              </div>
            <div class="mb-3 d-flex align-items-center mt-3">
                <label for="setting-input-8" class="form-label me-3 mb-0">案件狀態</label>
                <div id="setting-input-8" class="d-flex">
                  <div class="form-check me-3">
                    <input class="form-check-input" type="radio" name="work_status" id="status1" value="公開販售" {% if ViewKey_DbWorkInfo_work_id.work_status == '公開販售' %}checked{% endif %}>
                    <label class="form-check-label badge bg-success" for="status1">
                      公開販售
                    </label>
                  </div>
                  <div class="form-check me-3">
                    <input class="form-check-input" type="radio" name="work_status" id="status2" value="投稿審查" {% if ViewKey_DbWorkInfo_work_id.work_status == '投稿審查' %}checked{% endif %}>
                    <label class="form-check-label badge bg-danger" for="status2">
                      投稿審查
                    </label>
                  </div>
                  <div class="form-check me-3">
                    <input class="form-check-input" type="radio" name="work_status" id="status3" value="已成交" {% if ViewKey_DbWorkInfo_work_id.work_status == '已成交' %}checked{% endif %}>
                    <label class="form-check-label badge bg-info" for="status3">
                      已成交
                    </label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="work_status" id="status4" value="取消販售" {% if ViewKey_DbWorkInfo_work_id.work_status == '取消販售' %}checked{% endif %}>
                    <label class="form-check-label badge bg-secondary" for="status4">
                      取消販售
                    </label>
                  </div>
                </div>
              </div>              
              </div>
              <div class="d-flex justify-content-end mt-3">
                <a href="#" id="cancelButton" class="btn app-btn-secondary me-2">返回上層</a>
                <button type="submit" class="btn app-btn-primary">保存更改</button>
              </div>
        </form>
      </div>
      <!--//app-card-body-->
    </div>
    
    <!--//app-card-->
  </div>
  <div class="col-12 col-md-4 d-flex flex-column">
    <div class="app-card app-card-settings shadow-sm p-4 mb-4 d-flex flex-column" style="flex-grow: 1;">
      <div class="content-wrapper">
        <div class="mb-2"><strong>發布時間：</strong> {{ ViewKey_DbWorkInfo_work_id.publish_time|date:"Y-m-d H:i:s" }}</div>
        <div class="mb-2"><strong>最後更新：</strong> {{ ViewKey_DbWorkInfo_work_id.last_update|date:"Y-m-d H:i:s" }}</div>
        <p></p>
        <h6>作品預覽圖</h6>

        <!-- 檢查是否有預覽圖資料 -->
        {% if ViewKey_DbWorkEdit_sketches %} {# 從後端獲取的預覽圖資料集 #}
          <!-- 建立彈性容器用於顯示圖片預覽 -->
          <div class="d-flex flex-wrap justify-content-start mt-3" id="image-preview-container">

            <!-- 遍歷所有預覽圖並顯示 -->
            {% for sketches in ViewKey_DbWorkEdit_sketches %} {# 迭代每張預覽圖 #}
              <!-- 建立圖片預覽包裝容器 -->
              <div class="d-flex align-items-center justify-content-center image-preview-wrapper" style="width: calc(50% - 10px); margin-right: 10px; margin-bottom: 10px;">
                <!-- 顯示預覽圖 -->
                <img src="{{ MEDIA_URL }}commission/workID_img/{{ sketches.image_url }}" alt="作品預覽圖 {{ sketches.step }}" style="width: 100%; height: auto; object-fit: cover; border-radius: 5px;">
              </div>
            {% endfor %}

            <!-- 如果預覽圖數量少於5張，顯示上傳佔位符 -->
            {% if ViewKey_DbWorkEdit_sketches|length < 5 %} {# 檢查是否還可以上傳更多圖片 #}

              <!-- 根據已有圖片數量顯示剩餘可上傳數量的佔位符 -->
              {% for i in "12345"|slice:ViewKey_DbWorkEdit_sketches.count %} {# 動態生成剩餘空位 #}

                <!-- 建立圖片上傳佔位符 -->
                <div class="d-flex align-items-center justify-content-center image-upload-placeholder" style="width: calc(33.33% - 10px); height: 100px; background-color: #e0e0e0; border-radius: 5px; cursor: pointer; margin-right: 10px; margin-bottom: 10px;">
                  <!-- 顯示加號圖示 -->
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle" viewBox="0 0 16 16">
                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                    <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/>
                  </svg>
                </div>
              {% endfor %}
            {% endif %}
            <!-- <a href="{% url 'commission:Urls_upload_compare' %}?work_id={{ ViewKey_DbWorkInfo_work_id.work_id }}">AI比對測試</a> -->
          </div>
        {% else %}
          <!-- 當沒有預覽圖時顯示提示文字 -->
          <p>目前沒有預覽圖</p>

          <!-- 建立空的圖片預覽容器 -->
          <div class="d-flex flex-wrap justify-content-start mt-3" id="image-preview-container">

            <!-- 顯示5個上傳佔位符 -->
            {% for i in "12345" %} {# 生成5個上傳位置 #}
              <!-- 建立圖片上傳佔位符 -->
              <div class="d-flex align-items-center justify-content-center image-upload-placeholder" style="width: calc(33.33% - 10px); height: 100px; background-color: #e0e0e0; border-radius: 5px; cursor: pointer; margin-right: 10px; margin-bottom: 10px;">

                <!-- 顯示加號圖示 -->
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle" viewBox="0 0 16 16">

                  <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                  <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/>

                </svg>
              </div>

            {% endfor %}

          </div>
        {% endif %}
        <!-- 隱藏的檔案上傳輸入框 -->
        <input type="file" id="image-upload-input" style="display: none;" accept="image/*" multiple>

      </div>

      <!-- <div class="flex-grow-1"></div> -->
    </div>
    
    <div class="app-card shadow-sm p-4 mt-auto rounded-3 worker-info-card">
      <h3 class="section-title">作者資訊</h3>
      <!-- 作者大頭貼 -->
      <div class="mb-2">
        {% if ViewKey_DbPublicCardInfo.user_avatar %}
          <img style="width: 120px" src="{{ MEDIA_URL }}commission/publiccard/avatar/{{ ViewKey_DbPublicCardInfo.user_avatar }}" alt="{{ ViewKey_DbPublicCardInfo.user_nickname }}的頭像" />
        {% else %}
          <!-- 無大頭貼 -->
          <img style="width:50px" src="https://thumb.ac-illust.com/b1/b170870007dfa419295d949814474ab2_w.jpeg" alt="{{ ViewKey_DbPublicCardInfo.user_nickname }}的頭像" />
        {% endif %}
      </div>
      <div class="mb-2"><strong>作者ID：</strong> {{ ViewKey_DbWorkInfo_work_id.worker_id }}</div>
      <div class="mb-2"><strong>作者暱稱：</strong> {{ ViewKey_DbPublicCardInfo.user_nickname }}</div>
      <div class="mb-2"><strong>作者介紹：</strong> {{ ViewKey_DbPublicCardInfo.user_introduction }}</div>
    </div>
  </div>
</div>
<!--//row-->
{% endblock %} 
{% block app_script %}
<!-- 如果應用程式有自己的JAVA Script放這邊 -->
<script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // 追蹤表單變更
    const form = document.querySelector('.settings-form');
    let originalFormData = new FormData(form); // 用於追蹤原始表單數據
    const changedFields = new Set(); // 用於追蹤已更改的欄位
    let renamedFiles = new Map(); // 用於追蹤重命名的檔案
    // 追蹤所有選擇的文件
    let allSelectedFiles = [];

    // 監聽所有輸入欄位的變更
    form.querySelectorAll('input, textarea').forEach(input => {
      input.addEventListener('change', function() {
        const currentValue = this.type === 'file' ? 
          (this.files.length > 0 ? this.files[0].name : '') : 
          this.value;
        const originalValue = originalFormData.get(this.name);
        
        if (currentValue !== originalValue) {
          changedFields.add(this.name);
        } else {
          changedFields.delete(this.name);
        }
      });
    });

    // 當重新整理頁面時，重置表單
    window.addEventListener('beforeunload', function() {
      form.reset();
    });

    let imageDeleted = false; // 追蹤是否有原有圖片被刪除
    let newImageChanges = new Set(); // 追蹤新增的圖片變更

    // 處理文件選擇
    function handleFileSelection(files) {
      let currentImages = imagePreviewContainer.querySelectorAll('.image-preview-wrapper');
      let placeholders = imagePreviewContainer.querySelectorAll('.image-upload-placeholder');
      const remainingPlaceholders = placeholders.length;
      
      // 決定要處理的文件數量
      // const filesToProcess = Math.min(files.length, placeholders.length);
      // const filesToProcess = remainingPlaceholders > 0 
      //   ? Math.min(files.length, remainingPlaceholders) 
      //   : Math.min(files.length, maxImages - currentImages.length);
      // 本次修改：移除這行，因為它會覆蓋之前的文件
    // allSelectedFiles = [...allSelectedFiles, ...files];
    
    // 本次修改：決定要處理的文件數量
    const maxTotalImages = 5;
    const currentTotal = allSelectedFiles.length;
    const filesToProcess = Math.min(
        files.length, 
        maxTotalImages - currentTotal
    );
    
    // 本次修改：將新文件添加到 allSelectedFiles
    for (let i = 0; i < filesToProcess; i++) {
        allSelectedFiles.push(files[i]);
    }

    let fileIndex = 0;

      // 更新圖片預覽
      // updateImagePreview(allSelectedFiles);

      function processNextFile() {
        if (fileIndex >= filesToProcess) {
          adjustImageSizes();
          updatePlaceholders();
          return;
        }

        const file = files[fileIndex];
        const reader = new FileReader();

    reader.onload = function(e) {
      const wrapper = document.createElement('div');
      wrapper.className = 'image-preview-wrapper';
      wrapper.dataset.isNewImage = 'true';
      wrapper.dataset.position = placeholders[fileIndex].dataset.position; // 記錄位置

            const img = document.createElement('img');
            img.src = e.target.result;
            img.style.width = '100%';
            img.style.height = 'auto';
            img.style.objectFit = 'cover';

            const iconContainer = createIconContainer();

            wrapper.appendChild(img);
            wrapper.appendChild(iconContainer);

                    if (placeholders.length > 0) {
                      
            // 優先填充灰色加號 DIV
            imagePreviewContainer.replaceChild(wrapper, placeholders[0]);
            
              newImageChanges.add(wrapper); // 記錄新增的圖片
              changedFields.add('work_ex_image');
            placeholders = imagePreviewContainer.querySelectorAll('.image-upload-placeholder');
          } else {
            // 如果沒有灰色加號 DIV，則添加到現有圖片後面
            imagePreviewContainer.appendChild(wrapper);
          }

          currentImages = imagePreviewContainer.querySelectorAll('.image-preview-wrapper');
          imagePreviewContainer.replaceChild(wrapper, placeholders[fileIndex]);
      fileIndex++;
      processNextFile();
        };

        reader.readAsDataURL(file);
      }

      processNextFile();
    }

    // 更新圖片預覽的函數
    function updateImagePreview() {
      const imagePreviewContainer = document.getElementById('image-preview-container');
      imagePreviewContainer.innerHTML = ''; // 清空現有預覽
      // 顯示所有已選擇的圖片
      allSelectedFiles.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const wrapper = document.createElement('div');
          wrapper.className = 'image-preview-wrapper';
          wrapper.dataset.isNewImage = 'true';
          wrapper.dataset.fileIndex = index;

          const img = document.createElement('img');
          img.src = e.target.result;
          img.style.width = '100%';
          img.style.height = 'auto';
          img.style.objectFit = 'cover';

                const iconContainer = createIconContainer();
                
                wrapper.appendChild(img);
                wrapper.appendChild(iconContainer);
                imagePreviewContainer.appendChild(wrapper);
            };
            reader.readAsDataURL(file);
        });
// 添加剩餘的預留位置
const remainingSlots = 5 - allSelectedFiles.length;
        for (let i = 0; i < remainingSlots; i++) {
            const placeholder = createPlaceholder();
            imagePreviewContainer.appendChild(placeholder);
        }
        
      // 將所有選擇的文件添加到預覽中
    files.forEach(file => {
      const reader = new FileReader();
      reader.onload = function(e) {
        const wrapper = document.createElement('div');
        wrapper.className = 'image-preview-wrapper';

        const img = document.createElement('img');
        img.src = e.target.result;
        img.style.width = '100%';
        img.style.height = 'auto';
        img.style.objectFit = 'cover';

        const iconContainer = createIconContainer();

        wrapper.appendChild(img);
        wrapper.appendChild(iconContainer);
        imagePreviewContainer.appendChild(wrapper);
      };
      reader.readAsDataURL(file);
    });
  }

    // 全域變數，用於追蹤要刪除的圖片
    let deletedImages = [];
    // 刪除預覽圖的函數
    function deleteImage(wrapper) {
      if (wrapper.dataset.isNewImage === 'true') {
        // 如果刪除的是新增的圖片
        newImageChanges.delete(wrapper);
        if (newImageChanges.size === 0) {
          changedFields.delete('work_ex_image');
        }
      } else {
        // 如果刪除的是原有的圖片
        imageDeleted = true;
      }
      wrapper.remove();
      updatePlaceholders();
    }

    // 檢視原圖的函數
    function showImageModal(imgSrc) {
      const modalOverlay = document.createElement('div');
      modalOverlay.className = 'modal-overlay'; // 使用新樣式
      const modalImage = document.createElement('img');
      modalImage.src = imgSrc;
      modalImage.className = 'modal-image'; // 使用新樣式

      modalOverlay.appendChild(modalImage);
      document.body.appendChild(modalOverlay);

      modalOverlay.addEventListener('click', function() {
        document.body.removeChild(modalOverlay);
      });
    }

    // 處理表單提交
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(form);

      // 強制檢查需求案輸入框的變更
      const currentCaseValue = document.getElementById('setting-input-11').value;
      const originalCaseValue = originalFormData.get('case_by_need');
      if (currentCaseValue !== originalCaseValue) {
        changedFields.add('case_by_need');
      }
      // 添加重命名的原始檔資訊到formData
      const renamedFilesValue = document.getElementById('renamed-files').value;
      if (renamedFilesValue) {
        formData.append('renamed_files', renamedFilesValue);
      }
      // 添加所有累積的文件
      allSelectedFiles.forEach((file, index) => {
      // formData.append('work_ex_image', file);
      // 新增：顯示每個上傳的檔案資訊
      console.log(`(1添加所有累積的文件)上傳檔案 ${index + 1}:`, {
        name: file.name,
        size: file.size,
        type: file.type
      });
    });
    
    // 將從原始檔選擇的圖片檔經右側預覽顯示後加到 allSelectedFiles 陣列中以寫入資料庫
    const originalFiles = document.getElementById('setting-input-7').files;
    Array.from(originalFiles).forEach(file => {
      allSelectedFiles.push(file);
    });
    
    // 檢查是否有實際的變更
    const hasRealChanges = changedFields.size > 0 || 
                      (deletedImages && deletedImages.length > 0) ||
                      document.getElementById('renamed-files').value !== '';  // 添加檢查重命名檔案

    console.log('提交時的變更狀態:', {
        changedFields: Array.from(changedFields),
        hasRealChanges,
        renamedFiles: document.getElementById('renamed-files').value
    });
    // 修改表單提交處理
    if (hasRealChanges) {
       // 添加重命名的檔案資訊到formData
       const renamedFilesValue = document.getElementById('renamed-files').value;
       if (renamedFilesValue) {
                formData.append('renamed_files', renamedFilesValue);
                console.log('重命名檔案資訊:', renamedFilesValue);
            }
      changedFields.forEach(fieldName => {
        const input = form.querySelector(`[name="${fieldName}"]`);
        
        // 移除非檔案類型的判斷式 else if 部分
        if (input && input.type !== 'file') {
          formData.append(fieldName, input.value);
        }
      });

  // 統一在此處處理檔案上傳
  allSelectedFiles.forEach((file, index) => {
  formData.append('work_ex_image', file);  // 使用固定欄位名稱

  });

      // 處理要刪除的圖片
      if (deletedImages.length > 0) {
        formData.append('deleted_images', JSON.stringify(deletedImages));
      }

      // 處理圖片更新（包含替換和新增）
      const imageWrappers = document.querySelectorAll('.image-preview-wrapper');
      imageWrappers.forEach((wrapper, index) => {
        if (wrapper.dataset.isReplaced === 'true' && wrapper.file) {
          // 處理替換的圖片
          formData.append('replaced_images', JSON.stringify({
            original: wrapper.dataset.originalFileName,
            new: wrapper.file.name,
            index: index
          }));
          formData.append(`replacement_file_${index}`, wrapper.file);
        } else if (wrapper.dataset.isNewImage === 'true') {
          // 處理新增的圖片
          const img = wrapper.querySelector('img');
          if (img && wrapper.file) {
            // formData.append('work_ex_image', wrapper.file);
          }
        }
      });
      // 假設這段代碼在處理替換圖片時被調用
      const replacedImages = [];
      document.querySelectorAll('.image-preview-wrapper').forEach((wrapper, index) => {
        if (wrapper.dataset.isReplaced === 'true') {
          replacedImages.push({
            original: wrapper.dataset.originalFileName,
            index: index
          });
        }
      });

      // 將 replacedImages 轉換為 JSON 字符串並附加到表單數據中
      formData.append('replaced_images', JSON.stringify(replacedImages));
      // 新增：顯示最終要發送的 FormData 內容
      console.log('FormData 內容:');
      for (let pair of formData.entries()) {
        if (pair[1] instanceof File) {
          console.log(pair[0], {
            fileName: pair[1].name,
            fileSize: pair[1].size,
            fileType: pair[1].type
          });
        } else {
          console.log(pair[0], pair[1]);
        }
      }

      fetch('{% url "commission:Urls_work_edit" ViewKey_DbWorkInfo_work_id.work_id %}', {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          alert('更新成功！');
          sessionStorage.setItem('updatedFields', JSON.stringify(Array.from(changedFields)));
          window.location.reload(true);
        } else {
          alert('更新失敗：' + data.message);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('發生錯誤，請稍後再試');
        // 發生錯誤時也恢復被隱藏的圖片
        document.querySelectorAll('.image-preview-wrapper[style*="display: none"]')
          .forEach(wrapper => wrapper.style.display = '');
        deletedImages = []; // 重置刪除清單
      });
    } else {
      alert('沒有任何更改');
    }
  });

  // 當無上一頁可返回時，返回commission/work_list/
  const cancelButton = document.getElementById('cancelButton');
  cancelButton.addEventListener('click', function(e) {
    e.preventDefault();
    if (window.history.length > 1) {
      window.history.back();
    } else {
      window.location.href = "{% url 'commission:Urls_work_list' %}";
    }
  });
  const imageUploadInput = document.getElementById('image-upload-input');
  const settingInput5 = document.getElementById('setting-input-5');
  const imagePreviewContainer = document.getElementById('image-preview-container');
  const maxImages = 5;

  // 當點擊灰色加號方框時，觸發文件選擇
  imagePreviewContainer.addEventListener('click', function(event) {
    if (event.target.closest('.image-upload-placeholder')) {
      imageUploadInput.click();
    }
  });

  // 當左側的文件選擇工具被使用時，觸發右側的文件選擇工具
  settingInput5.addEventListener('change', function(event) {
    imageUploadInput.files = event.target.files;
    handleFileSelection(event.target.files);
    
    // 將文件輸入視為更改
    if (event.target.files.length > 0) {
      changedFields.add('work_ex_image'); // 添加文件輸入到更改欄位
    }
  });

  // 當右側的文件選擇工具被使用時，觸發左側的文件選擇工具
  imageUploadInput.addEventListener('change', function(event) {
    settingInput5.files = event.target.files;
    handleFileSelection(event.target.files);
    
    // 將文件輸入視為更改
    if (event.target.files.length > 0) {
      changedFields.add('work_ex_image'); // 添加文件輸入到更改欄位
    }
  });

  // 預覽圖操作功能
  function createIconContainer() {
      // 宣告iconContainer為圖片操作按鈕
      const iconContainer = document.createElement('div');
      iconContainer.className = 'icon-container';
      iconContainer.innerHTML = `
          <button class="icon-button" title="檢視原圖">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                  <path fill-rule="evenodd" d="M6.5 12a5.5 5.5 0 1 0 0-11 5.5 5.5 0 0 0 0 11M13 6.5a6.5 6.5 0 1 1-13 0 6.5 6.5 0 0 1 13 0"/>
                  <path d="M10.344 11.742q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1 6.5 6.5 0 0 1-1.398 1.4z"/>
                  <path fill-rule="evenodd" d="M6.5 3a.5.5 0 0 1 .5.5V6h2.5a.5.5 0 0 1 0 1H7v2.5a.5.5 0 0 1-1 0V7H3.5a.5.5 0 0 1 0-1H6V3.5a.5.5 0 0 1 .5-.5"/>
              </svg>
          </button>
          <button class="icon-button replace-image" title="更換圖片">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                  <path d="M4.502 9a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3"/>
                  <path d="M14.002 13a2 2 0 0 1-2 2h-10a2 2 0 0 1-2-2V5A2 2 0 0 1 2 3a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v8a2 2 0 0 1-1.998 2M14 2H4a1 1 0 0 0-1 1h9.002a2 2 0 0 1 2 2v7A1 1 0 0 0 15 11V3a1 1 0 0 0-1-1M2.002 4a1 1 0 0 0-1 1v8l2.646-2.354a.5.5 0 0 1 .63-.062l2.66 1.773 3.71-3.71a.5.5 0 0 1 .577-.094l1.777 1.947V5a1 1 0 0 0-1-1z"/>
              </svg>
          </button>
          <button class="icon-button delete-image" title="刪除">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                  <path d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5M11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66h.538a.5.5 0 0 0 0-1zm1.958 1-.846 10.58a1 1 0 0 1-.997.92h-6.23a1 1 0 0 1-.997-.92L3.042 3.5zm-7.487 1a.5.5 0 0 1 .528.47l.5 8.5a.5.5 0 0 1-.998.06L5 5.03a.5.5 0 0 1 .47-.53Zm5.058 0a.5.5 0 0 1 .47.53l-.5 8.5a.5.5 0 1 1-.998-.06l.5-8.5a.5.5 0 0 1 .528-.47M8 4.5a.5.5 0 0 1 .5.5v8.5a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5"/>
              </svg>
          </button>
      `;

    // 監聽圖片操作按鈕事件
    iconContainer.addEventListener('click', function(e) {
      // 若點擊的不是按鈕，則顯示原圖
      if (!e.target.closest('.icon-button')) {
        e.stopPropagation(); // 停止事件冒泡
        // 追查原圖路徑
        const imgSrc = e.target.closest('.image-preview-wrapper').querySelector('img').src;
        // 呼叫檢視原圖的函數
        showImageModal(imgSrc);
      }
    });

    // 當點擊「檢視原圖」按鈕時的事件處理
    iconContainer.querySelector('.icon-button[title="檢視原圖"]').addEventListener('click', function(e) {
      e.stopPropagation(); // 停止事件冒泡
      // 追查原圖路徑
      const imgSrc = e.target.closest('.image-preview-wrapper').querySelector('img').src;
      // 呼叫檢視原圖的函數
      showImageModal(imgSrc);
    });

    // 當點擊「更換圖片」按鈕時的事件處理
    iconContainer.querySelector('.replace-image').addEventListener('click', function(e) {
      e.stopPropagation(); // 停止事件冒泡
      const wrapper = e.target.closest('.image-preview-wrapper');
      // 呼叫更換預覽圖的函數
      replaceImage(wrapper);
    });

    // 當點擊「刪除」按鈕時的事件處理
    iconContainer.querySelector('.delete-image').addEventListener('click', function(e) {
      e.stopPropagation(); // 停止事件冒泡
      const wrapper = e.target.closest('.image-preview-wrapper');
      // 呼叫刪除預覽圖的函數
      deleteImage(wrapper);
    });

    return iconContainer;
  }

  // 更換預覽圖的函數
  function replaceImage(wrapper) {
    const imageUploadInput = document.createElement('input');
    imageUploadInput.type = 'file';
    imageUploadInput.accept = 'image/*';
    imageUploadInput.style.display = 'none';
    document.body.appendChild(imageUploadInput);

    // 儲存原始圖片的資訊
    const originalImageUrl = wrapper.querySelector('img').src;
    const originalFileName = originalImageUrl.split('/').pop();

    imageUploadInput.click();

      imageUploadInput.onchange = function(event) {
          const file = event.target.files[0];
          if (file) {
              const reader = new FileReader();
              reader.onload = function(e) {
                wrapper.querySelector('img').src = e.target.result;
                wrapper.dataset.originalFileName = originalFileName; // 儲存原始檔案名
                wrapper.dataset.replacementFile = file.name; // 儲存新檔案名
                wrapper.dataset.isReplaced = 'true'; // 標記這是被替換的圖片
                changedFields.add('work_ex_image'); // 添加文件輸入到更改欄位
                  // 儲存最後選擇的圖片
                //  wrapper.dataset.selectedImage = file; // 儲存選擇的圖片
              };
              reader.readAsDataURL(file);
              // 將檔案存儲在wrapper中，以便之後提交
              wrapper.file = file;
          }
          document.body.removeChild(imageUploadInput);
      };
  }

  // 刪除預覽圖的函數
  function deleteImage(wrapper) {
    const img = wrapper.querySelector('img');
    const imgUrl = img.src;
    const fileName = imgUrl.split('/').pop(); // 從 URL 取得檔案名稱
    
    if (wrapper.dataset.isNewImage === 'true') {
      // 如果是新上傳的圖片，直接移除元素
      wrapper.remove();
      newImageChanges.delete(wrapper);
      if (newImageChanges.size === 0) {
        changedFields.delete('work_ex_image');
      }
    } else {
      // 如果是既有的圖片，加入到待刪除清單
      deletedImages.push(fileName);
      wrapper.style.display = 'none'; // 先隱藏元素，但不立即移除
      changedFields.add('deleted_images');
    }
    const fileIndex = parseInt(wrapper.dataset.fileIndex);
    if (!isNaN(fileIndex)) {
      allSelectedFiles.splice(fileIndex, 1); // 從陣列中移除該文件
      updateImagePreview(); // 重新更新預覽
    }
    wrapper.remove();
    updatePlaceholders();
  }

  // 檢視原圖的函數
  function showImageModal(imgSrc) {
    const modalOverlay = document.createElement('div');
    modalOverlay.className = 'modal-overlay'; // 使用新樣式
    const modalImage = document.createElement('img');
    modalImage.src = imgSrc;
    modalImage.className = 'modal-image'; // 使用新樣式

    modalOverlay.appendChild(modalImage);
    document.body.appendChild(modalOverlay);

    modalOverlay.addEventListener('click', function() {
      document.body.removeChild(modalOverlay);
    });
  }
  // let imageDeleted = false; // 追蹤是否有原有圖片被刪除
  // let newImageChanges = new Set(); // 追蹤新增的圖片變更

  // 處理文件選擇
  function handleFileSelection(files) {
    let currentImages = imagePreviewContainer.querySelectorAll('.image-preview-wrapper');
    let placeholders = imagePreviewContainer.querySelectorAll('.image-upload-placeholder');
    const remainingPlaceholders = placeholders.length;

    // 決定要處理的文件數量
    const filesToProcess = remainingPlaceholders > 0 
      ? Math.min(files.length, remainingPlaceholders) 
      : Math.min(files.length, maxImages);

    let fileIndex = 0;
    let replacementIndex = 0;

    function processNextFile() {
      if (fileIndex >= filesToProcess) {
        adjustImageSizes();
        updatePlaceholders();
        return;
      }

      const file = files[fileIndex];
      const reader = new FileReader();

      reader.onload = function(e) {
          const wrapper = document.createElement('div');
          wrapper.className = 'image-preview-wrapper';
          wrapper.dataset.isNewImage = 'true'; // 標記這是新增的圖片


          const img = document.createElement('img');
          img.src = e.target.result;
          img.style.width = '100%';
          img.style.height = 'auto';
          img.style.objectFit = 'cover';

          const iconContainer = createIconContainer();

          wrapper.appendChild(img);
          wrapper.appendChild(iconContainer);

                  if (placeholders.length > 0) {
                    
                  // 優先填充灰色加號 DIV
                  imagePreviewContainer.replaceChild(wrapper, placeholders[0]);
                  
                    newImageChanges.add(wrapper); // 記錄新增的圖片
                    changedFields.add('work_ex_image');
                  placeholders = imagePreviewContainer.querySelectorAll('.image-upload-placeholder');
                } else {
                  // 如果沒有灰色加號 DIV，則替換現有圖片
                  if (currentImages[replacementIndex]) {
                    imagePreviewContainer.replaceChild(wrapper, currentImages[replacementIndex]);
                  } else {
                    imagePreviewContainer.appendChild(wrapper);
                  }
                  replacementIndex = (replacementIndex + 1) % maxImages;
                }

                currentImages = imagePreviewContainer.querySelectorAll('.image-preview-wrapper');
                fileIndex++;
                processNextFile();
      };

      reader.readAsDataURL(file);
    }

    processNextFile();
  }
  const existingImages = document.querySelectorAll('.image-preview-wrapper');
      existingImages.forEach(wrapper => {
          const iconContainer = createIconContainer();
          wrapper.appendChild(iconContainer);
      });

      function updatePlaceholders() {
        const currentImages = imagePreviewContainer.querySelectorAll('.image-preview-wrapper');
        const placeholders = imagePreviewContainer.querySelectorAll('.image-upload-placeholder');

        // 移除所有現有的佔位符
        placeholders.forEach(placeholder => placeholder.remove());

        // 添加剩餘的灰色加號DIV
        for (let i = currentImages.length; i < maxImages; i++) {
          const placeholder = createPlaceholder();
          imagePreviewContainer.appendChild(placeholder);
        }
      }

      function createPlaceholder() {
        const placeholder = document.createElement('div');
        placeholder.className = 'd-flex align-items-center justify-content-center image-upload-placeholder';
        placeholder.style.width = 'calc(33.33% - 10px)';
        placeholder.style.height = '100px';
        placeholder.style.backgroundColor = '#e0e0e0';
        placeholder.style.borderRadius = '5px';
        placeholder.style.cursor = 'pointer';
        placeholder.style.marginRight = '10px';
        placeholder.style.marginBottom = '10px';

        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('width', '16');
        svg.setAttribute('height', '16');
        svg.setAttribute('fill', 'currentColor');
        svg.classList.add('bi', 'bi-plus-circle');
        svg.setAttribute('viewBox', '0 0 16 16');

        const path1 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path1.setAttribute('d', 'M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16');

        const path2 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path2.setAttribute('d', 'M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4');

        svg.appendChild(path1);
        svg.appendChild(path2);
        placeholder.appendChild(svg);

        return placeholder;
      }
  // 調整圖片和佔位符的大小
  function adjustImageSizes() {
    const images = imagePreviewContainer.querySelectorAll('.image-preview-wrapper');
    const placeholders = imagePreviewContainer.querySelectorAll('.image-upload-placeholder');
    const totalItems = images.length + placeholders.length;

    // 設定不同數量下的預覽圖尺寸
    const setSize = (element, size) => {
      element.style.width = size;
      // 保持佔位符固定高度，圖片使用自動高度維持比例
      element.style.height = size === 'calc(33.33% - 10px)' ? '100px' : (element.classList.contains('image-upload-placeholder') ? '100px' : 'auto');
    };
    // 根據當前項目的總數量調整大小
  if (totalItems <= 3) {
      // 3 個以下項目時顯示 3 列佈局
      images.forEach(img => setSize(img, 'calc(33.33% - 10px)'));
      placeholders.forEach(placeholder => setSize(placeholder, 'calc(33.33% - 10px)'));
  } else if (totalItems <= 6) {
      // 4-6 個項目時顯示 2 列佈局
      images.forEach(img => setSize(img, 'calc(50% - 10px)'));
      // 將所有佔位符的大小設置為固定值
      placeholders.forEach(placeholder => setSize(placeholder, 'calc(33.33% - 10px)')); // 確保佔位符的寬度
  } else {
      // 7 個以上項目時顯示 4 列佈局 (理論上不會發生，因限制最多5張)
      images.forEach(img => setSize(img, 'calc(25% - 10px)'));
      // 將所有佔位符的大小設置為固定值
      placeholders.forEach(placeholder => setSize(placeholder, 'calc(33.33% - 10px)')); // 確保佔位符的寬度
  }
  }

      // 初始化佔位符
      updatePlaceholders();
      // =====上傳原始檔相關函式=====
      // 上傳原始檔-獲取檔案輸入元素和檔案資訊顯示區域
      const fileInput = document.getElementById('setting-input-7');
  // ===== 初始化檔案資訊顯示 =====
    // 新增：從後端獲取已存在的原始檔案資料
    const originalFiles = JSON.parse('{{ original_files_json|escapejs }}');
    const fileInfo = document.getElementById('fileInfo');
    const deletedOriginalFiles = []; // 將變數定義移到這裡

    // 創建 flex 容器(與上傳檔案顯示方式一致)
    const flexContainer = document.createElement('div');
    flexContainer.className = 'd-flex flex-wrap gap-3';
    fileInfo.appendChild(flexContainer);

  // ===== 處理已存在的原始檔案 =====
  // 已存在的原始檔-處理檔名排除顯示唯一值的函數
  function getDisplayFileName(fullFileName) {
      // 使用正則表達式移除時間戳記部分
      return fullFileName.replace(/^\d+_/, '');
  }

    // 已存在的原始檔-先依照 original_file_id 排序
    const sortedOriginalFiles = originalFiles.sort((a, b) => a.original_file_id - b.original_file_id);
    
    // 使用 async IIFE 來確保順序
    (async () => {
      for (const file of sortedOriginalFiles) {
        // 組合檔案 URL(使用 Django 模板變數)
        const fileUrl = `{{ MEDIA_URL }}commission/workID_file/${file.work_id}/${file.original_file_url}`;
        
        try {
          const response = await fetch(fileUrl);
          if (!response.ok) throw new Error('檔案載入失敗');
          const blob = await response.blob();

          // 已存在的原始檔-創建檔案資訊卡片(樣式與上傳檔案相同)
          const fileDetails = document.createElement('div');
          fileDetails.className = 'border rounded p-2 bg-light';
          fileDetails.style.minWidth = '200px';
          fileDetails.style.maxWidth = '300px';

          // 已存在的原始檔-基本檔案資訊(與上傳檔案相同結構)
          let fileInfoHTML = `
            <div class="d-flex align-items-start justify-content-between mb-1 position-relative">
              <div class="d-flex align-items-start flex-grow-1 pe-4">
                ${getFileIcon(blob.type, file.original_file_url)} <!-- 使用動態圖示函數，並傳入檔名 -->
                <span class="text-break file-name" data-original-name="${file.original_file_url}" data-extension="${getFileExtension(file.original_file_url)}">${getDisplayFileName(file.original_file_url)}</span>
              </div>
              <button type="button" class="btn btn-link text-danger p-0 delete-file position-absolute top-0 end-0" style="line-height: 1;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                  <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
                  <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
                </svg>
              </button>
            </div>
            <div class="ms-4 text-muted small">
              <div>類型：${blob.type || '未知類型'}</div>
              <div>大小：${formatFileSize(blob.size)}</div>
          `;

          // 如果是圖片檔案，讀取額外資訊
          if (blob.type.startsWith('image/')) {
            const img = new Image();
            img.src = fileUrl;
            
            img.onload = async function() {
              // 建立FormData物件
              const formData = new FormData();
              formData.append('image', blob);
              
              try {
                // 從cookie中獲取CSRF token
                const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                
                // 發送請求到後端API
                const response = await fetch('/commission/api/image-info/', {
                  method: 'POST',
                  headers: {
                    'X-CSRFToken': csrftoken
                  },
                  body: formData,
                  credentials: 'same-origin'  // 需要包含cookies
                });
                
                if (!response.ok) {
                  throw new Error('Network response was not ok');
                }
                
                const imageInfo = await response.json();
                
                // 更新顯示資訊
                const dpiInfo = imageInfo.dpi_x === imageInfo.dpi_y 
                  ? `DPI：${imageInfo.dpi_x}` 
                  : `DPI：${imageInfo.dpi_x} x ${imageInfo.dpi_y}`;
                  
                const additionalInfo = `
                  <div>尺寸：${imageInfo.width} x ${imageInfo.height} px</div>
                  <div>${dpiInfo}</div>
                `;
                
                const infoContainer = fileDetails.querySelector('.ms-4');
                if (infoContainer) {
                  infoContainer.innerHTML += additionalInfo;
                }
                
              } catch (error) {
                console.error('Error fetching image info:', error);
                // 如果發生錯誤，顯示基本資訊
                const basicInfo = `
                  <div>尺寸：${this.width} x ${this.height} px</div>
                  <div>DPI：提交以顯示DPI資訊</div>
                `;
                const infoContainer = fileDetails.querySelector('.ms-4');
                if (infoContainer) {
                  infoContainer.innerHTML += basicInfo;
                }
              }
            };
          } else if (file.original_file_url.match(/\.(zip|rar|7z)$/i)) {
            // 處理壓縮檔樹狀結構
            const formData = new FormData();
            formData.append('archive', blob, file.original_file_url);
            
            try {
              // 獲取 CSRF token
              const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
              
              const response = await fetch('/commission/api/archive-info/', {
                method: 'POST',
                headers: {
                  'X-CSRFToken': csrftoken
                },
                body: formData,
                credentials: 'same-origin'  // 需要包含 cookies
              });
              
              if (!response.ok) {
                throw new Error(`HTTP 錯誤! 狀態碼: ${response.status}`);
              }
              
              const archiveInfo = await response.json();
              
              if (archiveInfo.success && archiveInfo.files.length > 0) {
                // 建立樹狀結構資料
                const tree = {};
                const allPaths = archiveInfo.files
                  .filter(f => !f.includes('__MACOSX/'))
                  .sort((a, b) => a.localeCompare(b)); // 排序路徑

                let totalLines = 0; // 新增：總行數計數器
                allPaths.forEach(path => {
                  const parts = path.split('/');
                  let currentLevel = tree;
                  parts.forEach((part, index) => {
                    if (!currentLevel[part]) {
                      currentLevel[part] = { isFile: index === parts.length - 1 };
                      totalLines++; // 計算總行數
                    }
                    currentLevel = currentLevel[part];
                  });
                });

                // 生成樹狀結構 HTML
                const generateTreeHTML = (node, depth = 0, isLast = [], lineCount = {value:0}, showAll = false) => {
                  let html = '';
                  const keys = Object.keys(node).filter(k => k !== 'isFile');
                  
                  keys.forEach((key, index) => {
                    // 如果不是顯示全部且已經超過4行，則跳過
                    if (!showAll && lineCount.value >= 4) return;
                    
                    const isLastItem = index === keys.length - 1;
                    const isFile = node[key].isFile;
                    
                    // 只有在前4行或showAll為true時才生成行內容
                    if (showAll ? lineCount.value >= 4 : lineCount.value < 4) {
                      // 生成前導符號
                      let line = '';
                      for (let i = 0; i < depth; i++) {
                        line += isLast[i] ? '&nbsp;&nbsp;&nbsp;&nbsp;' : '│&nbsp;&nbsp;&nbsp;';
                      }
                      
                      line += isLastItem 
                        ? (depth === 0 ? '└── ' : '└── ')
                        : (depth === 0 ? '├── ' : '├── ');

                      // 添加檔案/目錄行
                      html += `
                        <div class="tree-line">
                          <div class="tree-indent" style="flex-shrink: 0;">${line}</div>
                          <span class="tree-filename" 
                                style="white-space: nowrap; 
                                      overflow: hidden;
                                      text-overflow: ellipsis;
                                      max-width: 150px;" 
                                title="${key}${isFile ? '' : '/'}">
                            ${key}${isFile ? '' : '/'}
                          </span>
                        </div>
                      `;
                    }
                    
                    lineCount.value++;
                    
                    // 遞迴處理子目錄
                    if (!isFile) {
                      html += generateTreeHTML(node[key], depth + 1, [...isLast, isLastItem], lineCount, showAll);
                    }
                  });
                  
                  return html;
                };

                // 生成初始的樹狀結構（前4行）
                const initialTreeHtml = generateTreeHTML(tree, 0, [], {value: 0}, false);
                
                // 生成完整的樹狀結構（用於展開時顯示）
                const fullTreeHtml = generateTreeHTML(tree, 0, [], {value: 0}, true);

                fileInfoHTML += `
                  <div>壓縮檔內容：</div>
                  <div class="ms-3" id="fileTreeContainer">
                    <div class="initial-content">
                      ${initialTreeHtml}
                    </div>
                    ${totalLines > 4 ? `
                      <div class="tree-line overflow-trigger" 
                           style="cursor:pointer;text-align:center;"
                           data-remaining="${totalLines - 4}"
                           onclick="toggleTreeLines(this)">
                          點擊顯示下略 ${totalLines - 4} 行 ▼
                      </div>
                      <div class="overflow-content" style="display:none;">
                        ${fullTreeHtml}
                      </div>
                    ` : ''}
                  </div>
                `;
              }
            } catch (error) {
              console.error('取得壓縮檔資訊錯誤:', error);
            }
          }
          
          fileInfoHTML += '</div>'; // 關閉 ms-4 div
          fileDetails.innerHTML = fileInfoHTML;
 

          // 添加刪除按鈕的事件監聽器
          const deleteButton = fileDetails.querySelector('.delete-file');
          deleteButton.addEventListener('click', function() {
            // 移除檔案資訊顯示
            fileDetails.remove();
            
            // 將檔案名稱加入到被刪除檔案的陣列中
            deletedOriginalFiles.push(file.original_file_url);
            
            // 更新隱藏欄位的值
            document.getElementById('deleted-original-files').value = JSON.stringify(deletedOriginalFiles);
            
            // 標記表單有變更
            changedFields.add('original_files');
            
            // 只有當所有新上傳的檔案都被刪除時，才清空新上傳區域
            const remainingNewFiles = flexContainer.querySelectorAll('[data-is-new-upload="true"]');
            if (remainingNewFiles.length === 0) {
              // 檢查是否還有後端讀入的檔案
              const remainingOriginalFiles = flexContainer.querySelectorAll(':not([data-is-new-upload="true"])');
              if (remainingOriginalFiles.length === 0) {
                fileInfo.innerHTML = '';
              }
            }
          });

          flexContainer.appendChild(fileDetails);
        } catch (error) {
          console.error('檔案載入錯誤:', error);
        }
      }
    })();

    
    // 上傳原始檔-監聽檔案選擇變更事件
  fileInput.addEventListener('change', function(e) {
  // 移除舊的清空檔案資訊的程式碼
  // fileInfo.innerHTML = '';
  
      // 使用已存在的 flex 容器，如果不存在才創建新的
      let flexContainer = fileInfo.querySelector('.d-flex.flex-wrap.gap-3');
      if (!flexContainer) {
        flexContainer = document.createElement('div');
        flexContainer.className = 'd-flex flex-wrap gap-3';
        fileInfo.appendChild(flexContainer);
      }

  // 檢查是否有圖片檔案需要預覽
  const imageFiles = Array.from(this.files).filter(file => file.type.startsWith('image/'));
  if (imageFiles.length > 0) {
    const imagePreviewContainer = document.getElementById('image-preview-container');
    const existingPreviews = imagePreviewContainer.querySelectorAll('.image-preview-wrapper');
    const availableSlots = 5 - existingPreviews.length;

    if (availableSlots > 0) {
      // 只處理可用空間內的圖片
      imageFiles.slice(0, availableSlots).forEach(file => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const wrapper = document.createElement('div');
          wrapper.className = 'image-preview-wrapper';
          wrapper.dataset.isNewImage = 'true';

          const img = document.createElement('img');
          img.src = e.target.result;
          img.style.width = '100%';
          img.style.height = 'auto';
          img.style.objectFit = 'cover';

          const iconContainer = createIconContainer();
          wrapper.appendChild(img);
          wrapper.appendChild(iconContainer);

          // 找到第一個可用的預留位置
          const placeholder = imagePreviewContainer.querySelector('.image-upload-placeholder');
          if (placeholder) {
            imagePreviewContainer.replaceChild(wrapper, placeholder);
          } else {
            imagePreviewContainer.appendChild(wrapper);
          }

          adjustImageSizes();
        };
        reader.readAsDataURL(file);
      });
    }
  }

      // 上傳原始檔-遍歷所有選擇的檔案
      Array.from(this.files).forEach((file, index) => {
        // 上傳原始檔-格式化檔案大小
        const fileSize = formatFileSize(file.size);

        // 上傳原始檔-創建檔案資訊元素
        const fileDetails = document.createElement('div');
        fileDetails.className = 'border rounded p-2 bg-light';
        fileDetails.style.minWidth = '200px';
        fileDetails.style.maxWidth = '300px';
        
        // 基本檔案資訊的HTML
        const basicInfo = `
          <div class="d-flex align-items-start justify-content-between mb-1 position-relative">
            <div class="d-flex align-items-start flex-grow-1 pe-4">
              ${getFileIcon(file.type, file.name)} <!-- 使用動態圖示函數，並傳入檔名 -->
              <span class="text-break file-name" 
                    data-original-name="${file.name}" 
                    data-extension="${getFileExtension(file.name)}">
                ${getDisplayFileName(file.name)}
              </span>
            </div>
            <button type="button" class="btn btn-link text-danger p-0 delete-file position-absolute top-0 end-0" style="line-height: 1;">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
                <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
              </svg>
            </button>
          </div>
          <div class="ms-4 text-muted small">
            <div>類型：${file.type || '未知類型'}</div>
            <div>大小：${fileSize}</div>
          </div>
        `;
        // 如果是圖片檔案，讀取額外資訊
        if (file.type.startsWith('image/')) {
          const img = new Image();
          const url = URL.createObjectURL(file);
          
          img.onload = async function() {
            // 建立FormData物件
          const formData = new FormData();
            formData.append('image', file);
          
          try {
                // 發送請求到後端API
                const response = await fetch('/commission/api/image-info/', {
              method: 'POST',
                    body: formData
                });
                
                const imageInfo = await response.json();
                
                // 更新顯示資訊
                const additionalInfo = `
                    <div>尺寸：${imageInfo.width} x ${imageInfo.height} px</div>
                    <div>水平分辨率：${imageInfo.dpi_x} dpi</div>
                    <div>垂直分辨率：${imageInfo.dpi_y} dpi</div>
                `;
                
                fileDetails.querySelector('.ms-4').innerHTML += additionalInfo;
                
            } catch (error) {
                console.error('Error fetching image info:', error);
                // 如果發生錯誤，顯示基本資訊
                const basicInfo = `
                    <div>尺寸：${this.width} x ${this.height} px</div>
                    <div>DPI：待表單提交後分析</div>
                `;
                fileDetails.querySelector('.ms-4').innerHTML += basicInfo;
            }
            
            URL.revokeObjectURL(url);
        };
        
        img.src = url;
      }
      fileDetails.innerHTML = basicInfo;
        flexContainer.appendChild(fileDetails);

        // 在這裡添加刪除按鈕的事件監聽器
        const deleteButton = fileDetails.querySelector('.delete-file');
          deleteButton.addEventListener('click', function() {
          const fileIndex = parseInt(this.dataset.fileIndex);
          const dt = new DataTransfer();
          const input = document.getElementById('setting-input-7');
          
          // 創建新的 FileList，排除被刪除的檔案
          Array.from(input.files).forEach((file, idx) => {
            if (idx !== fileIndex) {
              dt.items.add(file);
            }
          });
          
          // 更新input的files
          input.files = dt.files;
          
            // 移除檔案資訊顯示
          this.closest('.border').remove();
            
            // 只有當所有新上傳的檔案都被刪除時，才清空新上傳區域
            const remainingNewFiles = flexContainer.querySelectorAll('[data-is-new-upload="true"]');
            if (remainingNewFiles.length === 0) {
              // 檢查是否還有後端讀入的檔案
              const remainingOriginalFiles = flexContainer.querySelectorAll(':not([data-is-new-upload="true"])');
              if (remainingOriginalFiles.length === 0) {
                fileInfo.innerHTML = '';
              }
            }
          });
      });
    });

    // 上傳原始檔-格式化檔案大小的輔助函數
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // 在檔案輸入監聽器中添加刪除功能
    fileDetails.querySelector('.delete-file').addEventListener('click', function() {
      const fileIndex = parseInt(this.dataset.fileIndex);
      const dt = new DataTransfer();
      const input = document.getElementById('setting-input-7');
      
      // 創建新的 FileList，排除被刪除的檔案
      Array.from(input.files).forEach((file, idx) => {
        if (idx !== fileIndex) {
          dt.items.add(file);
        }
      });
      
      // 更新input的files
      input.files = dt.files;
      
      // 移除檔案資訊顯示
      this.closest('.border').remove();
      
      // 只有當所有新上傳的檔案都被刪除時，才清空新上傳區域
      const remainingNewFiles = flexContainer.querySelectorAll('[data-is-new-upload="true"]');
      if (remainingNewFiles.length === 0) {
        // 檢查是否還有後端讀入的檔案
        const remainingOriginalFiles = flexContainer.querySelectorAll(':not([data-is-new-upload="true"])');
        if (remainingOriginalFiles.length === 0) {
          fileInfo.innerHTML = '';
        }
      }
    });
  });

// 資料庫讀入原始檔-壓縮檔樹狀圖-修改切換顯示的函數
function toggleTreeLines(element) {
    const container = element.closest('#fileTreeContainer');
    const overflowContent = container.querySelector('.overflow-content');
    const initialContent = container.querySelector('.initial-content');
    
    if (overflowContent.style.display === 'none') {
        // initialContent.style.display = 'none';  // 隱藏前4行
        overflowContent.style.display = 'block';  // 顯示完整內容
        element.innerHTML = '點擊收合 ▲';
    } else {
        initialContent.style.display = 'block';  // 顯示前4行
        overflowContent.style.display = 'none';  // 隱藏完整內容
        element.innerHTML = `點擊顯示下略 ${element.dataset.remaining} 行 ▼`;
    }
    
    event.stopPropagation();
}
// ======= 修改原始檔名相關函數 =======
// 修改原始檔名-從檔名中提取副檔名的函數
function getFileExtension(filename) {
    // 使用正則表達式移除時間戳記部分（如果有的話）
    const cleanFilename = filename.replace(/^\d+_/, '');
    // 從檔名中提取副檔名
    const extension = cleanFilename.split('.').pop();
    return extension ? `.${extension}` : '';
}

// 在全域範圍定義 changedFields 集合
const changedFields = new Set();
// 檔案名稱編輯相關函數

// 修改：顯示檔名時包含副檔名的函數
function getDisplayFileName(fullFileName) {
    // 使用正則表達式移除時間戳記部分
    return fullFileName.replace(/^\d+_/, '');
}

// 修改：獲取不含副檔名的檔名（用於編輯）
function getFileNameWithoutExtension(fullFileName) {
    // 先移除時間戳記
    const cleanName = fullFileName.replace(/^\d+_/, '');
    // 移除副檔名
    return cleanName.replace(/\.[^/.]+$/, '');
}

function makeFileNameEditable() {
  // 儲存修改過的檔名
  let renamedFiles = new Map();
    
    document.addEventListener('click', function(e) {
        const fileNameSpan = e.target.closest('.file-name');
        if (fileNameSpan && !fileNameSpan.querySelector('input')) {
            const originalName = fileNameSpan.dataset.originalName;
            const extension = fileNameSpan.dataset.extension;
            // 取得不含副檔名的檔名用於編輯
            const nameWithoutExtension = getFileNameWithoutExtension(fileNameSpan.textContent.trim());
            
            // 創建輸入框
            const input = document.createElement('input');
            input.type = 'text';
            input.value = nameWithoutExtension; // 設置不含副檔名的值
            input.className = 'form-control form-control-sm';
            input.style.width = '100%';
            
            // 自動全選文字功能
            input.addEventListener('focus', function() {
                this.select();
            });

            // 在輸入框顯示後立即觸發全選
            setTimeout(() => {
                input.focus();
                input.select();
            }, 10);
            
            // 替換span為input
            fileNameSpan.textContent = '';
            fileNameSpan.appendChild(input);
            
            // 處理輸入完成
            function handleComplete() {
                const newNameWithoutExtension = input.value.trim();
                if (newNameWithoutExtension && newNameWithoutExtension !== nameWithoutExtension) {
                    // 儲存新舊檔名的對應關係（加上副檔名）
                    renamedFiles.set(originalName, newNameWithoutExtension + extension);
                    // 更新隱藏欄位
                    document.getElementById('renamed-files').value = JSON.stringify(Array.from(renamedFiles.entries()));
                    // 標記表單有變更
                    changedFields.add('renamed_files');
                }
                // 恢復為span顯示，確保顯示包含副檔名
                fileNameSpan.textContent = newNameWithoutExtension + extension;
            }
            
            // 監聽Enter鍵和失去焦點事件
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleComplete();
                }
            });
            
            input.addEventListener('blur', handleComplete);
        }
    });
}

// 初始化檔名編輯功能
makeFileNameEditable();

// ========= 原始檔-動態圖示函數 =========
// 新增一個根據檔案類型回傳對應圖示的函數
function getFileIcon(fileType, fileName) { // 函數加入 fileName 參數
  // 定義檔案類型對應的圖示
  const iconMap = {
    'image': `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-image me-2 flex-shrink-0" viewBox="0 0 16 16">
      <path d="M8.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
      <path d="M12 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2zM3 2a1 1 0 0 1 1-1h8a1 1 0 0 1 1 1v8l-2.083-2.083a.5.5 0 0 0-.76.063L8 11 5.835 9.7a.5.5 0 0 0-.611.076L3 12V2z"/>
    </svg>`,

    'video': `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-play me-2 flex-shrink-0" viewBox="0 0 16 16">
      <path d="M6 10.117V5.883a.5.5 0 0 1 .757-.429l3.528 2.117a.5.5 0 0 1 0 .858l-3.528 2.117a.5.5 0 0 1-.757-.43z"/>
      <path d="M4 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H4zm0 1h8a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1z"/>
    </svg>`,

    'audio': `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-music me-2 flex-shrink-0" viewBox="0 0 16 16">
      <path d="M10.304 3.13a1 1 0 0 1 1.196.98v1.8l-2.5.5v5.09c0 .495-.301.883-.662 1.123C7.974 12.866 7.499 13 7 13c-.5 0-.974-.134-1.338-.377-.36-.24-.662-.628-.662-1.123s.301-.883.662-1.123C6.026 10.134 6.501 10 7 10c.356 0 .7.068 1 .196V4.41a1 1 0 0 1 .804-.98l1.5-.3z"/>
      <path d="M4 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H4zm0 1h8a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1z"/>
    </svg>`,

    'pdf': `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-pdf me-2 flex-shrink-0" viewBox="0 0 16 16">
      <path d="M4 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H4zm0 1h8a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1z"/>
      <path d="M4.603 12.087a.81.81 0 0 1-.438-.42c-.195-.388-.13-.776.08-1.102.198-.307.526-.568.897-.787a7.68 7.68 0 0 1 1.482-.645 19.701 19.701 0 0 0 1.062-2.227 7.269 7.269 0 0 1-.43-1.295c-.086-.4-.119-.796-.046-1.136.075-.354.274-.672.65-.823.192-.077.4-.12.602-.077a.7.7 0 0 1 .477.365c.088.164.12.356.127.538.007.187-.012.395-.047.614-.084.51-.27 1.134-.52 1.794a10.954 10.954 0 0 0 .98 1.686 5.753 5.753 0 0 1 1.334.05c.364.065.734.195.96.465.12.144.193.32.2.518.007.192-.047.382-.138.563a1.04 1.04 0 0 1-.354.416.856.856 0 0 1-.51.138c-.331-.014-.654-.196-.933-.417a5.716 5.716 0 0 1-.911-.95 11.642 11.642 0 0 0-1.997.406 11.311 11.311 0 0 1-1.021 1.51c-.29.35-.608.655-.926.787a.793.793 0 0 1-.58.029zm1.379-1.901c-.166.076-.32.156-.459.238-.328.194-.541.383-.647.547-.094.145-.096.25-.04.361.01.022.02.036.026.044a.27.27 0 0 0 .035-.012c.137-.056.355-.235.635-.572a8.18 8.18 0 0 0 .45-.606zm1.64-1.33a12.647 12.647 0 0 1 1.01-.193 11.666 11.666 0 0 1-.51-.858 20.741 20.741 0 0 1-.5 1.05zm2.446.45c.15.162.296.3.435.41.24.19.407.253.498.256a.107.107 0 0 0 .07-.015.307.307 0 0 0 .094-.125.436.436 0 0 0 .059-.2.095.095 0 0 0-.026-.063c-.052-.062-.2-.152-.518-.209a3.881 3.881 0 0 0-.612-.053zM8.078 5.8a6.7 6.7 0 0 0 .2-.828c.031-.188.043-.343.038-.465a.613.613 0 0 0-.032-.198.517.517 0 0 0-.145.04c-.087.035-.158.106-.196.283-.04.192-.03.469.046.822.024.111.054.227.09.346z"/>
    </svg>`,

    'zip': `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-zip me-2 flex-shrink-0" viewBox="0 0 16 16">
      <path d="M6.5 7.5a1 1 0 0 1 1-1h1a1 1 0 0 1 1 1v.938l.4 1.599a1 1 0 0 1-.416 1.074l-.93.62a1 1 0 0 1-1.109 0l-.93-.62a1 1 0 0 1-.415-1.074l.4-1.599V7.5zm2 0h-1v.938a1 1 0 0 1-.03.243l-.4 1.598.93.62.93-.62-.4-1.598a1 1 0 0 1-.03-.243V7.5z"/>
      <path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2zm5.5-1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H9v1H8v1h1v1H8v1h1v1H7.5V5h-1V4h1V3h-1V2h1V1z"/>
    </svg>`
  };

  // 定義副檔名對應的圖示 (當 MIME Type 無法判斷時使用)
  const extensionMap = {
    'jpg': iconMap.image,
    'jpeg': iconMap.image,
    'png': iconMap.image,
    'gif': iconMap.image,
    'bmp': iconMap.image,
    'webp': iconMap.image,
    'mp4': iconMap.video,
    'mov': iconMap.video,
    'avi': iconMap.video,
    'wmv': iconMap.video,
    'mpeg': iconMap.video,
    'mpg': iconMap.video,
    'mkv': iconMap.video,
    'mp3': iconMap.audio,
    'wav': iconMap.audio,
    'ogg': iconMap.audio,
    'flac': iconMap.audio,
    'aac': iconMap.audio,
    'pdf': iconMap.pdf,
    'zip': iconMap.zip,
    'rar': iconMap.zip,
    '7z': iconMap.zip,
  };

  // 取得主要檔案類型
  const mainType = fileType.split('/')[0];
  const extensionFromType = fileType.split('/')[1];

  // 根據檔案類型回傳對應圖示
  if (iconMap[mainType]) return iconMap[mainType];
  if (fileType === 'application/pdf') return iconMap.pdf;
  if (extensionFromType === 'zip' || extensionFromType === 'x-zip-compressed' || extensionFromType === 'x-rar-compressed') return iconMap.zip;

  // 從檔名中取得副檔名
  const fileExtension = fileName.split('.').pop().toLowerCase();

  // 根據副檔名回傳對應圖示
  if (extensionMap[fileExtension]) return extensionMap[fileExtension];

  // 預設檔案圖示
  return `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark me-2 flex-shrink-0" viewBox="0 0 16 16">
    <path d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5L14 4.5zm-3 0A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4.5h-2z"/>
  </svg>`;
}

// ===== 提交表單後欄位更新的視覺效果 =====
  // 在頁面載入時檢查是否有更新過的欄位
    const updatedFields = JSON.parse(sessionStorage.getItem('updatedFields') || '[]');
    
    if (updatedFields.length > 0) {
      // 清除儲存的欄位資訊
      sessionStorage.removeItem('updatedFields');
      
      // 只對更新過的欄位添加視覺效果
      updatedFields.forEach(fieldName => {
        // 處理一般輸入欄位
        const input = document.querySelector(`[name="${fieldName}"]`);
        if (input) {
          if (fieldName === 'work_status') {
            const statusContainer = document.querySelector('#setting-input-8');
            if (statusContainer) {
              statusContainer.style.backgroundColor = '#e8f0fe';
              statusContainer.style.boxShadow = '0 0 0 8px #e8f0fe'; // 使用 box-shadow 創造視覺空間
              statusContainer.style.borderRadius = '0.1px'; // 添加圓角效果
              setTimeout(() => {
                statusContainer.style.transition = 'background-color 1s, box-shadow 1s';
                statusContainer.style.backgroundColor = '';
                statusContainer.style.boxShadow = '';
              }, 2000); // 案件狀態更新後的視覺效果停留秒數
            }
          } else {
            input.style.backgroundColor = '#e8f0fe';
            
            setTimeout(() => {
              input.style.transition = 'background-color 1s';
              input.style.backgroundColor = '';
            }, 2000); // 其他輸入欄位資料更新後的視覺效果停留秒數
          }
        }
      });
    };

  // =====投稿需求案選擇功能=====
  document.addEventListener('DOMContentLoaded', function() {
  const input = document.getElementById('setting-input-11');
  const popup = document.getElementById('needInfoPopup');
  const tableBody = document.getElementById('needInfoTableBody');
  const titleDisplay = document.getElementById('needTitleDisplay');
  
  // 更新標題顯示的函數
  async function updateNeedTitle(needId) {
    if (!needId) {
      titleDisplay.textContent = "未有綁定的需求案";
      return;
    }

    try {
      const response = await fetch('/commission/api/need-info/');
      const needInfoList = await response.json();
      const needInfo = needInfoList.find(info => info.need_id.toString() === needId.toString());

      titleDisplay.textContent = needInfo ? needInfo.need_title : "未有綁定的需求案";
    } catch (error) {
      console.error('Error fetching need info:', error);
      titleDisplay.textContent = "載入失敗";
    }
  }

  // 初始載入標題
  updateNeedTitle(input.value);

  // 當輸入框獲得焦點時顯示懸浮窗
  async function showNeedInfoPopup() {
    try {
      // 從後端獲取需求案列表
      const response = await fetch('/commission/api/need-info/');
      const needInfoList = await response.json();
      // 清空表格內容
      tableBody.innerHTML = '';
      // 填充表格數據
      needInfoList.forEach(info => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>
            <input type="radio" name="need_selection" value="${info.need_id}" 
              ${input.value == info.need_id ? 'checked' : ''}>
          </td>
          <td>${info.need_id}</td>
          <td>${info.need_title}</td>
          <td>${info.need_category}</td>
          <td>${info.need_original_from || ''}</td>
        `;
        // 當整行被點擊時，選擇對應的radio按鈕

        row.addEventListener('click', function() {
          const radio = row.querySelector('input[type="radio"]');
          radio.checked = true;
          input.value = radio.value; // 更新輸入框的值

          // 手動觸發輸入框變更事件
          const event = new Event('change', {
            bubbles: true,
            cancelable: true,
          });
          input.dispatchEvent(event);

          updateNeedTitle(radio.value); // 更新標題顯示
          popup.style.display = 'none'; // 隱藏懸浮窗
        });

        tableBody.appendChild(row);
      });
      // 顯示懸浮窗
      popup.style.display = 'block';
      // 滾動父層頁面以檢視懸浮窗全貌
      window.parent.scrollBy({
        top: 300,
        behavior: 'smooth' // 添加平滑滾動效果
      });

    } catch (error) {
      console.error('Error fetching need info:', error);
    }
  }

  // 當輸入框獲得焦點時顯示懸浮窗
  input.addEventListener('focus', showNeedInfoPopup);

  // 當文字標籤被點擊時顯示懸浮窗
  titleDisplay.addEventListener('click', showNeedInfoPopup);

  // 當輸入框值變更時更新標題
  input.addEventListener('change', function() {
    updateNeedTitle(this.value);
  });

  // 當點擊其他地方時隱藏懸浮窗
  document.addEventListener('click', function(e) {
    if (!input.contains(e.target) && !popup.contains(e.target) && !titleDisplay.contains(e.target)) {
      popup.style.display = 'none';
    }
  });


});


</script>

{% endblock %}